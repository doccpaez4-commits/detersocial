<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Security headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src https://fonts.gstatic.com; img-src 'self' data: blob:; connect-src 'none';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <title>Epidemiolog√≠a Cr√≠tica & HiMupAC | Instrumento Pedag√≥gico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600&display=swap" rel="stylesheet">

    <style>
        /* ===== DESIGN TOKENS ‚Äî LIGHT MODE ===== */
        :root {
            --bg-page:      #fdf6ee;
            --glass:        rgba(255,255,255,0.62);
            --glass-sm:     rgba(255,255,255,0.72);
            --glass-border: rgba(255,255,255,0.80);
            --glass-shadow: 0 8px 32px rgba(120,53,15,0.09), 0 1.5px 6px rgba(120,53,15,0.05);
            --blur:         blur(18px);
            --accent:       #b45309;
            --accent-dark:  #78350f;
            --accent-light: rgba(180,83,9,0.10);
            --sus: #059669; --sob: #b91c1c; --sol: #d97706; --seg: #0369a1;
            --txt-heading: #1c1917;
            --txt-strong:  #292524;
            --txt-body:    #44403c;
            --txt-caption: #57534e;
            --txt-muted:   #78716c;
            --input-bg:    rgba(255,255,255,0.82);
            --input-border:rgba(180,83,9,0.22);
            --input-ph:    #57534e;
            --divider:     rgba(229,231,235,0.55);
            --row-hover:   rgba(255,251,235,0.7);
            /* Fluid type scale */
            --fs-xs:   clamp(0.72rem,  0.68rem + 0.18vw, 0.82rem);
            --fs-sm:   clamp(0.82rem,  0.78rem + 0.22vw, 0.96rem);
            --fs-base: clamp(0.92rem,  0.86rem + 0.3vw,  1.08rem);
            --fs-md:   clamp(1.02rem,  0.94rem + 0.42vw, 1.22rem);
            --fs-lg:   clamp(1.18rem,  1.02rem + 0.75vw, 1.55rem);
            --fs-xl:   clamp(1.45rem,  1.12rem + 1.5vw,  2.1rem);
            --fs-2xl:  clamp(1.75rem,  1.3rem  + 2.1vw,  2.7rem);
        }

        /* ===== DARK MODE TOKENS ===== */
        .dark {
            --bg-page:      #141210;
            --glass:        rgba(30,25,22,0.80);
            --glass-sm:     rgba(38,32,28,0.84);
            --glass-border: rgba(255,255,255,0.08);
            --glass-shadow: 0 8px 32px rgba(0,0,0,0.45), 0 1.5px 6px rgba(0,0,0,0.28);
            --accent:       #f59e0b;
            --accent-dark:  #fbbf24;
            --accent-light: rgba(245,158,11,0.12);
            --txt-heading: #fafaf9;
            --txt-strong:  #e7e5e4;
            --txt-body:    #d6d3d1;
            --txt-caption: #a8a29e;
            --txt-muted:   #78716c;
            --input-bg:    rgba(45,38,32,0.88);
            --input-border:rgba(245,158,11,0.25);
            --input-ph:    #78716c;
            --divider:     rgba(255,255,255,0.08);
            --row-hover:   rgba(45,38,32,0.8);
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            font-size: var(--fs-base);
            line-height: 1.65;
            background-color: var(--bg-page);
            background-image:
                radial-gradient(ellipse 80% 50% at 18% 8%,  rgba(253,186,116,0.22) 0%, transparent 58%),
                radial-gradient(ellipse 60% 40% at 82% 78%, rgba(167,243,208,0.17) 0%, transparent 55%),
                radial-gradient(ellipse 50% 60% at 58% 28%, rgba(147,197,253,0.11) 0%, transparent 50%);
            color: var(--txt-heading);
            min-height: 100vh;
            overflow-x: hidden;
        }
        .dark body, body.dark {
            background-image:
                radial-gradient(ellipse 80% 50% at 18% 8%,  rgba(180,83,9,0.15) 0%, transparent 58%),
                radial-gradient(ellipse 60% 40% at 82% 78%, rgba(5,150,105,0.12) 0%, transparent 55%),
                radial-gradient(ellipse 50% 60% at 58% 28%, rgba(59,130,246,0.09) 0%, transparent 50%);
        }

        /* Heading hierarchy ‚Äî fluid sizes */
        h1 { font-family:'Cormorant Garamond',serif; font-size:var(--fs-2xl); font-weight:700; color:var(--txt-heading); letter-spacing:-0.01em; line-height:1.15; }
        h2 { font-family:'Cormorant Garamond',serif; font-size:var(--fs-xl);  font-weight:700; color:var(--txt-heading); line-height:1.2; }
        h3 { font-family:'Cormorant Garamond',serif; font-size:var(--fs-lg);  font-weight:700; color:var(--txt-strong);  line-height:1.25; }
        h4 { font-family:'DM Sans',sans-serif;       font-size:var(--fs-xs);  font-weight:700; color:var(--txt-strong);  text-transform:uppercase; letter-spacing:0.06em; }
        h5 { font-family:'DM Sans',sans-serif;       font-size:var(--fs-xs);  font-weight:600; color:var(--txt-caption); }
        p, li { color:var(--txt-body); font-size:var(--fs-sm); }
        label { color:var(--txt-strong); font-size:var(--fs-xs); }

        /* Glass panels */
        .glass {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            backdrop-filter: var(--blur);
            -webkit-backdrop-filter: var(--blur);
            border-radius: 16px;
            position: relative; z-index: 10;
            transition: background 0.35s ease, border-color 0.35s ease, box-shadow 0.3s ease;
        }
        .glass::before {
            content:''; position:absolute; inset:0; border-radius:16px;
            background:linear-gradient(135deg, rgba(255,255,255,0.28) 0%, rgba(255,255,255,0.02) 100%);
            pointer-events:none;
        }
        .dark .glass::before { background:linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.00) 100%); }
        .glass-sm {
            background: var(--glass-sm);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 16px rgba(120,53,15,0.07);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 12px;
            transition: background 0.35s ease, border-color 0.35s ease;
        }

        /* Inputs */
        .glass-input {
            background: var(--input-bg) !important;
            border: 1px solid var(--input-border) !important;
            border-radius: 10px;
            font-family: 'DM Sans', sans-serif;
            color: var(--txt-heading);
            font-size: var(--fs-sm);
            line-height: 1.6;
            transition: all 0.2s ease, background 0.35s ease;
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            width: 100%;
        }
        .glass-input::placeholder { color: var(--input-ph); font-style: italic; font-size: var(--fs-xs); }
        .glass-input:focus {
            background: rgba(255,255,255,0.97) !important; color: #1c1917;
            border-color: var(--accent) !important; outline: none;
            box-shadow: 0 0 0 3px rgba(180,83,9,0.12), 0 4px 12px rgba(180,83,9,0.07);
        }
        .dark .glass-input:focus { background: rgba(50,40,30,0.98) !important; color: #fafaf9; }
        textarea.glass-input { resize: none; }

        /* Floating orbs */
        .orb { position:fixed; pointer-events:none; z-index:0; border-radius:50%; filter:blur(40px); }
        .orb-1 { width:580px;height:580px;top:-12%;left:-8%;   background:radial-gradient(circle,rgba(253,186,116,0.28),transparent 70%);animation:orb1 26s ease-in-out infinite; }
        .orb-2 { width:420px;height:420px;bottom:4%;right:-4%; background:radial-gradient(circle,rgba(110,231,183,0.22),transparent 70%);animation:orb2 32s ease-in-out infinite; }
        .orb-3 { width:280px;height:280px;top:38%;left:58%;    background:radial-gradient(circle,rgba(147,197,253,0.18),transparent 70%);animation:orb3 22s ease-in-out infinite; }
        .dark .orb-1 { background:radial-gradient(circle,rgba(180,83,9,0.2),transparent 70%); }
        .dark .orb-2 { background:radial-gradient(circle,rgba(5,150,105,0.16),transparent 70%); }
        .dark .orb-3 { background:radial-gradient(circle,rgba(59,130,246,0.14),transparent 70%); }
        @keyframes orb1{0%,100%{transform:translate(0,0) scale(1)} 50%{transform:translate(28px,-18px) scale(1.04)}}
        @keyframes orb2{0%,100%{transform:translate(0,0)} 50%{transform:translate(-18px,14px)}}
        @keyframes orb3{0%,100%{transform:translate(0,0) scale(1)} 50%{transform:translate(14px,-22px) scale(0.96)}}

        /* Muisca icons */
        .icon-bg { position:fixed; z-index:0; pointer-events:none; }
        .spiral-shape    { bottom:3%;left:-3%;  width:500px;height:500px;opacity:0.038;color:#0f766e;animation:float 22s ease-in-out infinite; }
        .muisca-triangles{ top:18%;right:3%;   width:360px;height:360px;opacity:0.032;color:#b45309;animation:pulse 12s infinite alternate; }
        .chacana-big     { top:-8%;left:28%;   width:650px;height:650px;opacity:0.018;animation:spinSlow 360s linear infinite; }
        .dark .spiral-shape     { opacity:0.06; color:#2dd4bf; }
        .dark .muisca-triangles { opacity:0.05; color:#f59e0b; }
        .dark .chacana-big      { opacity:0.028; }
        @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-18px)}}
        @keyframes pulse{0%{opacity:0.022}100%{opacity:0.05}}
        @keyframes spinSlow{100%{transform:rotate(360deg)}}

        /* Navigation */
        .nav-pill {
            color: var(--txt-muted); font-family:'DM Sans',sans-serif;
            font-size:var(--fs-xs); font-weight:600; padding:8px 14px; border-radius:50px;
            transition:all 0.22s ease; white-space:nowrap; cursor:pointer;
            border:1.5px solid transparent; background:transparent; letter-spacing:0.3px;
        }
        .nav-pill.active { color:var(--accent-dark); background:var(--accent-light); border-color:rgba(180,83,9,0.25); box-shadow:0 2px 8px rgba(180,83,9,0.1); }
        .dark .nav-pill.active { color:var(--accent); border-color:rgba(245,158,11,0.3); background:rgba(245,158,11,0.1); }
        .nav-pill:hover:not(.active) { background:rgba(255,255,255,0.12); color:var(--accent); }

        /* Dark mode toggle */
        #dm-toggle {
            position:fixed; top:14px; right:16px; z-index:200;
            background:var(--glass); border:1px solid var(--glass-border);
            backdrop-filter:blur(12px); border-radius:50px; padding:6px 13px;
            cursor:pointer; font-size:var(--fs-xs); font-family:'DM Sans',sans-serif;
            font-weight:600; color:var(--txt-caption);
            transition:all 0.2s ease; display:flex; align-items:center; gap:6px;
            box-shadow:0 2px 8px rgba(0,0,0,0.1);
        }
        #dm-toggle:hover { box-shadow:0 4px 14px rgba(0,0,0,0.15); transform:translateY(-1px); }

        /* Buttons */
        .btn-primary {
            background:linear-gradient(135deg, #d97706 0%, #b45309 100%);
            color:white; font-family:'DM Sans',sans-serif; font-weight:600;
            font-size:var(--fs-xs); letter-spacing:0.8px; text-transform:uppercase;
            padding:11px 28px; border-radius:50px; border:none; cursor:pointer;
            box-shadow:0 4px 16px rgba(180,83,9,0.28),inset 0 1px 0 rgba(255,255,255,0.2);
            transition:all 0.2s ease; display:inline-flex; align-items:center; gap:8px;
        }
        .dark .btn-primary { background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%); }
        .btn-primary:hover  { transform:translateY(-2px); box-shadow:0 6px 22px rgba(180,83,9,0.36); filter:brightness(1.05); }
        .btn-primary:active { transform:translateY(1px); }

        .btn-glass {
            background:rgba(255,255,255,0.65); color:var(--accent-dark);
            font-family:'DM Sans',sans-serif; font-weight:600; font-size:var(--fs-xs);
            letter-spacing:0.4px; padding:9px 22px; border-radius:50px;
            border:1.5px solid rgba(180,83,9,0.25); cursor:pointer;
            backdrop-filter:blur(8px); box-shadow:0 2px 8px rgba(120,53,15,0.08);
            transition:all 0.2s ease;
        }
        .dark .btn-glass { background:rgba(40,32,24,0.7); color:var(--accent); border-color:rgba(245,158,11,0.3); }
        .btn-glass:hover { background:rgba(255,247,237,0.9); transform:translateY(-1px); box-shadow:0 4px 14px rgba(120,53,15,0.14); }
        .dark .btn-glass:hover { background:rgba(55,44,30,0.9); }

        .btn-tag { font-size:var(--fs-xs); font-weight:700; text-transform:uppercase; padding:4px 10px; border-radius:6px; cursor:pointer; border:1.5px solid transparent; transition:all 0.15s; background:rgba(255,255,255,0.7); }
        .dark .btn-tag { background:rgba(40,34,28,0.7); }
        .btn-tag-d { color:#be123c; border-color:rgba(190,18,60,0.22); }
        .btn-tag-d:hover { background:#fff1f2; border-color:#be123c; }
        .dark .btn-tag-d { color:#fca5a5; border-color:rgba(252,165,165,0.3); }
        .btn-tag-p { color:#15803d; border-color:rgba(21,128,61,0.22); }
        .btn-tag-p:hover { background:#f0fdf4; border-color:#15803d; }
        .dark .btn-tag-p { color:#86efac; border-color:rgba(134,239,172,0.3); }

        /* Process items */
        .process-item { display:flex; align-items:flex-start; gap:8px; font-size:var(--fs-sm); padding:8px 10px; margin-bottom:5px; border-radius:8px; }
        .item-destructive { background:rgba(254,226,226,0.72); border-left:3px solid #e11d48; }
        .item-protective  { background:rgba(220,252,231,0.72); border-left:3px solid #16a34a; }
        .dark .item-destructive { background:rgba(127,29,29,0.3); }
        .dark .item-protective  { background:rgba(20,83,45,0.3); }
        .delete-btn { color:#d4d0cc; cursor:pointer; font-weight:bold; padding:0 4px; flex-shrink:0; transition:color 0.15s; }
        .delete-btn:hover { color:#ef4444; }

        /* Tags */
        .tag { display:inline-block; padding:3px 8px; border-radius:6px; font-size:var(--fs-xs); margin:2px; font-weight:600; }
        .tag-crit { background:rgba(254,226,226,0.9); color:#991b1b; border:1px solid rgba(252,165,165,0.6); }
        .tag-prot { background:rgba(220,252,231,0.9); color:#166534; border:1px solid rgba(134,239,172,0.6); }
        .dark .tag-crit { background:rgba(127,29,29,0.4); color:#fca5a5; border-color:rgba(252,165,165,0.25); }
        .dark .tag-prot { background:rgba(20,83,45,0.4);  color:#86efac; border-color:rgba(134,239,172,0.25); }

        /* Synthesis table */
        .synthesis-table { width:100%; font-size:var(--fs-xs); border-collapse:collapse; }
        .synthesis-table th { background:rgba(255,247,237,0.92); padding:10px 12px; text-align:left; border-bottom:2px solid #ea580c; color:#78350f; font-weight:700; font-size:var(--fs-xs); text-transform:uppercase; letter-spacing:0.4px; }
        .synthesis-table td { padding:10px 12px; border-bottom:1px solid var(--divider); vertical-align:top; }
        .synthesis-table .row-header { font-weight:700; color:var(--accent-dark); background:rgba(250,250,249,0.8); border-right:1px solid var(--divider); font-size:var(--fs-xs); text-transform:uppercase; letter-spacing:0.3px; }
        .dark .synthesis-table th { background:rgba(40,30,20,0.8); color:var(--accent); border-bottom-color:var(--accent); }
        .dark .synthesis-table .row-header { background:rgba(30,24,18,0.8); color:var(--accent); }

        /* Subsunci√≥n */
        .subsumption-wrapper { width:420px;height:420px;position:relative;display:flex;justify-content:center;align-items:center; }
        @media(max-width:480px){ .subsumption-wrapper{transform:scale(0.68);margin:-66px auto;} }
        .circle-general   { width:380px;height:380px;border:2px dashed rgba(217,119,6,0.55);border-radius:50%;position:relative;display:flex;justify-content:center;align-items:center;background:rgba(255,251,235,0.28);backdrop-filter:blur(4px); }
        .circle-particular{ width:250px;height:250px;border:2px dashed rgba(13,148,136,0.55);border-radius:50%;position:relative;display:flex;justify-content:center;align-items:center;background:rgba(240,253,250,0.28); }
        .circle-individual{ width:120px;height:120px;border:2px solid rgba(245,158,11,0.8);border-radius:50%;position:relative;display:flex;justify-content:center;align-items:center;background:rgba(255,255,255,0.82);box-shadow:0 0 24px rgba(245,158,11,0.15); }
        .dark .circle-general    { background:rgba(60,40,0,0.2); }
        .dark .circle-particular { background:rgba(0,50,45,0.2); }
        .dark .circle-individual { background:rgba(40,30,10,0.9); }
        .circle-label { position:absolute;top:-13px;left:50%;transform:translateX(-50%);font-family:'DM Sans',sans-serif;font-weight:700;font-size:0.6rem;letter-spacing:1.5px;background:rgba(255,255,255,0.92);padding:3px 10px;border:1px solid rgba(214,211,209,0.55);border-radius:20px;color:#78350f;z-index:5;backdrop-filter:blur(6px); }
        .dark .circle-label { background:rgba(30,22,14,0.92); color:var(--accent); border-color:rgba(245,158,11,0.25); }

        .sub-tag{width:13px;height:13px;border-radius:50%;position:absolute;z-index:50;cursor:pointer;box-shadow:0 0 0 2px rgba(255,255,255,0.88),0 2px 6px rgba(0,0,0,0.22);transition:all 0.25s ease;}
        .sub-tag:hover{transform:scale(2.8);z-index:100;}
        .sub-tag .tooltip{visibility:hidden;width:175px;background:rgba(28,25,23,0.93);color:#fff;text-align:center;border-radius:8px;padding:7px 10px;position:absolute;bottom:160%;left:50%;margin-left:-87px;opacity:0;transition:opacity 0.2s;font-size:0.68rem;pointer-events:none;z-index:200;font-family:'DM Sans',sans-serif;}
        .sub-tag:hover .tooltip{visibility:visible;opacity:1;}

        /* HiMupAC */
        .him-chip{background:rgba(255,247,237,0.88);border:1.5px solid rgba(249,115,22,0.38);color:#78350f;padding:5px 12px;border-radius:20px;font-size:var(--fs-xs);display:inline-flex;align-items:center;gap:7px;font-weight:600;backdrop-filter:blur(6px);}
        .dark .him-chip{background:rgba(50,35,10,0.8);color:var(--accent);border-color:rgba(245,158,11,0.3);}
        .him-chip .close{cursor:pointer;opacity:0.5;transition:opacity 0.15s;font-weight:bold;}
        .him-chip .close:hover{opacity:1;}
        .selectable-item{cursor:pointer;transition:all 0.18s;border:1.5px solid transparent;border-radius:8px;}
        .selectable-item:hover{border-color:rgba(217,119,6,0.45);background:var(--row-hover);}
        .selectable-item.selected{background:rgba(255,247,237,0.82);border-color:rgba(180,83,9,0.38);font-weight:600;}
        .dark .selectable-item.selected{background:rgba(50,35,10,0.7);border-color:rgba(245,158,11,0.3);}

        /* Step badge */
        .step-badge{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:0.85rem;font-family:'DM Sans',sans-serif;flex-shrink:0;background:linear-gradient(135deg,#d97706,#78350f);color:white;}

        /* Autosave */
        #save-indicator{position:fixed;bottom:20px;right:16px;background:rgba(5,150,105,0.92);color:white;padding:7px 16px;border-radius:20px;font-size:var(--fs-xs);font-weight:600;opacity:0;transition:opacity 0.4s;z-index:1000;backdrop-filter:blur(8px);pointer-events:none;}
        #save-indicator.show{opacity:1;}

        /* Footer */
        .app-footer{font-size:var(--fs-xs);color:var(--txt-muted);text-align:center;padding:20px 16px 10px;line-height:1.8;}

        /* Scrollbar */
        ::-webkit-scrollbar{width:6px;height:6px;}
        ::-webkit-scrollbar-track{background:rgba(255,255,255,0.3);border-radius:3px;}
        ::-webkit-scrollbar-thumb{background:rgba(180,83,9,0.22);border-radius:3px;}
        .dark ::-webkit-scrollbar-thumb{background:rgba(245,158,11,0.25);}

        /* Wide screens */
        @media(min-width:1280px){ .glass{ border-radius:20px; } }
        @media(min-width:1600px){ .glass{ border-radius:22px; } }

        /* Mobile */
        @media(max-width:640px){
            .glass{ border-radius:12px; }
            .nav-pill{ font-size:0.68rem; padding:6px 9px; }
            textarea,input[type="text"],input[type="date"],select{ font-size:16px !important; }
            #dm-toggle{ top:10px; right:10px; padding:5px 10px; }
        }
        nav::-webkit-scrollbar{display:none;}
        nav{scrollbar-width:none;}
    </style>
</head>
<body>
    <!-- Autosave indicator -->
    <div id="save-indicator">üíæ Guardado</div>

    <!-- Dark mode toggle -->
    <button id="dm-toggle" onclick="toggleDark()" aria-label="Cambiar modo oscuro/claro">
        <span id="dm-icon">üåô</span>
        <span id="dm-label">Oscuro</span>
    </button>

    <!-- FONDOS MUISCAS -->
    
    <!-- Liquid glass orbs -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
    <div class="icon-bg spiral-shape"><svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M50 50 m 0 0 a 5 5 0 0 1 10 0 a 10 10 0 0 1 -20 0 a 15 15 0 0 1 30 0 a 20 20 0 0 1 -40 0 a 25 25 0 0 1 50 0"/></svg></div>
    <div class="icon-bg muisca-triangles"><svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="2"><polygon points="50,10 90,90 10,90"/><polygon points="50,25 75,75 25,75" opacity="0.5"/></svg></div>
    <div class="icon-bg chacana-big"><svg viewBox="0 0 100 100" fill="currentColor"><path d="M40,0 L60,0 L60,20 L80,20 L80,40 L100,40 L100,60 L80,60 L80,80 L60,80 L60,100 L40,100 L40,80 L20,80 L20,60 L0,60 L0,40 L20,40 L20,20 L40,20 Z"/></svg></div>

    <div class="w-full px-4 md:px-8 py-6 min-h-screen flex flex-col max-w-[1600px] mx-auto relative z-10">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 glass p-6 bg-white/95 backdrop-blur-sm">
            <div class="flex items-center gap-5">
                <svg class="w-14 h-14 text-amber-700 drop-shadow-sm" viewBox="0 0 100 100" fill="currentColor"><path d="M40,0 L60,0 L60,20 L80,20 L80,40 L100,40 L100,60 L80,60 L80,80 L60,80 L60,100 L40,100 L40,80 L20,80 L20,60 L0,60 L0,40 L20,40 L20,20 L40,20 Z"/></svg>
                <div>
                    <h1 class="text-2xl md:text-3xl font-black text-amber-900 tracking-tight">Epidemiolog√≠a Cr√≠tica</h1>
                    <p class="text-sm text-stone-600 font-light tracking-wide uppercase mt-1">Instrumento de Determinaci√≥n Social & HiMupAC</p>
                </div>
            </div>
            <div class="text-center md:text-right mt-4 md:mt-0">
                <p class="font-bold text-stone-700 text-xs uppercase tracking-wide border-b border-stone-300 pb-1 mb-1">Modelo Dial√©ctico</p>
                <p class="text-xs text-stone-500 font-serif italic">Basado en la obra de Jaime Breilh, 2023</p>
                <button onclick="clearAllData()" class="mt-2 text-xs text-stone-400 hover:text-red-500 underline cursor-pointer bg-transparent border-none">üóë Limpiar sesi√≥n</button>
            </div>
        </header>

        <!-- Navegaci√≥n -->
        <nav class="glass p-2 mb-6 flex overflow-x-auto gap-1 sm:gap-1.5 justify-start sm:justify-center sticky top-2 z-40">
            <button onclick="switchTab('instrucciones')" id="btn-instrucciones" class="nav-pill active">1. Conceptos</button>
            <button onclick="switchTab('diligenciar')" id="btn-diligenciar" class="nav-pill">2. Matriz</button>
            <button onclick="switchTab('visualizar')" id="btn-visualizar" class="nav-pill">3. S√≠ntesis</button>
            <button onclick="switchTab('recomendaciones')" id="btn-recomendaciones" class="nav-pill">4. Praxis</button>
            <button onclick="switchTab('himupac')" id="btn-himupac" class="nav-pill" style="color:#92400e;">5. HiMupAC</button>
            <button onclick="switchTab('evaluacion')" id="btn-evaluacion" class="nav-pill" style="color:#065f46;">6. Evaluaci√≥n</button>
        </nav>

        <main class="flex-grow w-full">
            
            <!-- 1. CONCEPTOS -->
            <section id="instrucciones" class="tab-content block pb-10">
                <div class="glass p-6 mb-8 bg-blue-50 border-l-4 border-blue-700 shadow-sm">
                    <div class="flex gap-4">
                        <span class="text-3xl">üí°</span>
                        <div>
                            <h3 class="text-blue-900 font-bold text-sm uppercase tracking-widest mb-1">Prop√≥sito Pedag√≥gico</h3>
                            <p class="text-blue-800 text-sm font-light leading-relaxed">
                                El prop√≥sito de este formato es aportar al proceso pedag√≥gico para analizar la <strong>determinaci√≥n social de la salud</strong> en los territorios. Buscamos superar la visi√≥n fragmentada del riesgo para comprender la salud como un proceso hist√≥rico y social complejo.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-8 mb-8">
                    <div class="glass p-8 border-t-4 border-amber-700 bg-white">
                        <h2 class="text-2xl font-bold text-stone-800 mb-4 font-serif">La Ruptura Epistemol√≥gica</h2>
                        <p class="text-stone-600 leading-relaxed text-sm mb-4 text-justify">
                            La epidemiolog√≠a convencional suele ver la salud como una suma de "factores de riesgo" desconectados. Esta herramienta te invita a pensar desde la <strong>Determinaci√≥n Social</strong>. No buscamos culpables individuales, buscamos la l√≥gica hist√≥rica y estructural que hace posible que la enfermedad florezca en un territorio.
                        </p>
                        <div class="grid grid-cols-2 gap-4 text-sm mt-4">
                            <div class="bg-stone-100 p-3 rounded">
                                <strong class="text-stone-700 block mb-2 uppercase text-xs">Paradigma Convencional</strong>
                                <ul class="list-disc pl-4 text-stone-600 text-xs space-y-1">
                                    <li>Fragmenta la realidad en variables sueltas ("riesgos").</li>
                                    <li>Se centra en el individuo descontextualizado.</li>
                                    <li>Usa la asociaci√≥n estad√≠stica simple (correlaci√≥n).</li>
                                </ul>
                            </div>
                            <div class="bg-amber-50 p-3 rounded border border-amber-100">
                                <strong class="text-amber-800 block mb-2 uppercase text-xs">Epidemiolog√≠a Cr√≠tica</strong>
                                <ul class="list-disc pl-4 text-stone-600 text-xs space-y-1">
                                    <li>Ve la realidad como un sistema complejo de procesos anidados.</li>
                                    <li>Conecta lo estructural (General) con lo corporal (Individual).</li>
                                    <li>Usa la Meta-inferencia.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="glass p-6 bg-stone-50 border-l-4 border-stone-400">
                        <h3 class="font-bold text-stone-700 text-sm uppercase tracking-widest mb-3">Gu√≠a de Dominios</h3>
                        <ul class="text-sm text-stone-600 space-y-4">
                            <li class="flex gap-2"><span class="font-black text-amber-800 text-lg">G</span><div><strong class="text-amber-900 block">GENERAL (L√≥gica Estructural)</strong> ¬øQu√© pol√≠ticas nacionales, modelos econ√≥micos globales, leyes o imposiciones culturales hegem√≥nicas determinan las reglas del juego en este territorio?</div></li>
                            <li class="flex gap-2"><span class="font-black text-teal-700 text-lg">P</span><div><strong class="text-teal-800 block">PARTICULAR (Modos de Vida)</strong> ¬øC√≥mo vive, trabaja y se organiza el grupo social espec√≠fico? ¬øCu√°les son sus patrones de exposici√≥n colectiva?</div></li>
                            <li class="flex gap-2"><span class="font-black text-amber-600 text-lg">I</span><div><strong class="text-amber-700 block">SINGULAR (Fenotipo Social)</strong> ¬øC√≥mo se encarnan estos procesos en la biolog√≠a, la psiquis y el sufrimiento corporal singular de cada persona? Breilh (2023) usa "Singular" para resaltar que no es el individuo abstracto, sino el modo singular en que los procesos sociales se expresan en el cuerpo.</div></li>
                        </ul>
                    </div>
                </div>
                <div class="text-center w-full pt-6"><button onclick="switchTab('diligenciar')" class="btn-primary">Comenzar An√°lisis ‚ûî</button></div>
            </section>

            <!-- 2. MATRIZ ‚Äî generada con JS, SIN document.write() -->
            <section id="diligenciar" class="tab-content hidden pb-10">
                <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4 bg-stone-100 p-4 rounded-lg border border-stone-200">
                    <h2 class="text-xl font-bold text-stone-700 font-serif">Laboratorio Territorial</h2>
                    <input type="text" id="territory-input" placeholder="Nombre del Territorio / Comunidad..."
                        class="glass-input px-4 py-2.5 w-full sm:w-80 md:w-96"
                        oninput="autoSave()">
                </div>
                <!-- Los paneles se inyectan aqu√≠ por JS (fix: sin document.write) -->
                <div id="matrix-panels" class="grid grid-cols-1 xl:grid-cols-2 gap-5 sm:gap-7 pb-8"></div>
                <div class="text-center w-full pb-10"><button onclick="switchTab('visualizar')" class="btn-primary">Visualizar S√≠ntesis ‚ûî</button></div>
            </section>

            <!-- 3. S√çNTESIS -->
            <section id="visualizar" class="tab-content hidden pb-10">
                <div class="flex flex-wrap justify-between items-center mb-8 gap-4">
                    <h2 class="text-2xl font-bold text-stone-700 font-serif">Perfil de Determinaci√≥n Social</h2>
                    <button onclick="exportToPDF()" class="btn-glass">üñ®Ô∏è Imprimir / Guardar PDF</button>
                </div>
                <div id="synthesis-print-wrapper">
                <div id="print-area" class="glass p-5 sm:p-8 md:p-10 w-full mb-6">
                    <div class="text-center mb-8 pb-6 border-b-2 border-amber-100">
                        <h1 class="text-3xl font-black text-amber-900 font-serif mb-2">Matriz de Procesos Cr√≠ticos</h1>
                        <p class="text-base text-stone-400 font-light" id="display-territory">Territorio: Sin definir</p>
                    </div>
                    <div id="table-container" class="mb-12 overflow-x-auto"></div>
                    <div class="pt-6 mb-8" style="border-top:1px solid rgba(229,231,235,0.4);">
                        <h4 class="text-xs font-bold text-stone-400 mb-5 uppercase tracking-widest text-center">Balance de Fuerzas</h4>
                        <div class="max-w-sm mx-auto" style="height:280px;"><canvas id="radarChart"></canvas></div>
                        <div class="glass-sm p-4 mt-5 text-xs text-stone-600 text-justify max-w-2xl mx-auto" style="border-radius:10px;background:rgba(255,255,255,0.62);border:1px solid rgba(255,255,255,0.8);">
                            <strong class="text-amber-900 block mb-1 uppercase tracking-wide text-xs">Lectura Cr√≠tica ‚Äî Metabolismo Social:</strong>
                            Este gr√°fico visualiza la tensi√≥n dial√©ctica entre la vida y la muerte en el territorio. Un predominio del √°rea <span class="text-red-600 font-bold">ROJA</span> indica un metabolismo social destructivo. El √°rea <span class="text-green-600 font-bold">VERDE</span> representa la resistencia social y los procesos que protegen y potencian la salud colectiva.
                        </div>
                    </div>
                    <div class="pt-6" style="border-top:1px solid rgba(229,231,235,0.4);">
                        <h4 class="text-xs font-bold text-stone-400 mb-5 uppercase tracking-widest text-center">Subsunci√≥n Dial√©ctica</h4>
                        <div class="flex justify-center overflow-x-auto">
                            <div class="subsumption-wrapper" id="subsumption-graphic"></div>
                        </div>
                        <div class="flex flex-wrap justify-center gap-3 sm:gap-4 mt-4 mb-4">
                            <span class="flex items-center gap-1.5 text-xs font-semibold text-stone-500"><span class="w-3 h-3 rounded-full inline-block" style="background:#059669;"></span>Sustentabilidad</span>
                            <span class="flex items-center gap-1.5 text-xs font-semibold text-stone-500"><span class="w-3 h-3 rounded-full inline-block" style="background:#b91c1c;"></span>Soberan√≠a</span>
                            <span class="flex items-center gap-1.5 text-xs font-semibold text-stone-500"><span class="w-3 h-3 rounded-full inline-block" style="background:#d97706;"></span>Solidaridad</span>
                            <span class="flex items-center gap-1.5 text-xs font-semibold text-stone-500"><span class="w-3 h-3 rounded-full inline-block" style="background:#0369a1;"></span>Seguridad</span>
                        </div>
                        <div class="glass-sm p-4 text-xs text-stone-600 text-justify max-w-2xl mx-auto" style="border-radius:10px;background:rgba(255,255,255,0.62);border:1px solid rgba(255,255,255,0.8);">
                            <strong class="text-amber-900 block mb-1 uppercase tracking-wide text-xs">Lectura Cr√≠tica ‚Äî Jerarqu√≠a de Determinaci√≥n:</strong>
                            No somos individuos aislados. La dimensi√≥n <strong>General</strong> (C√≠rculo Externo) envuelve y determina las condiciones de posibilidad de la dimensi√≥n <strong>Particular</strong> (Modos de vida grupales), y esta a su vez condiciona lo <strong>Singular</strong> (Cuerpo y estilos de vida). Los puntos de color muestran d√≥nde se concentran los problemas.
                        </div>
                    </div>
                </div>
                <div class="text-center mt-6 pb-8 flex flex-wrap justify-center gap-3"><button onclick="switchTab('diligenciar')" class="btn-glass">‚Üê Volver a Matriz</button><button onclick="switchTab('recomendaciones')" class="btn-primary">Continuar al Plan de Acci√≥n ‚ûî</button></div>
                </div><!-- /synthesis-print-wrapper -->
            </section>

            <!-- 4. PRAXIS -->
            <section id="recomendaciones" class="tab-content hidden pb-10">
                <div class="max-w-6xl mx-auto">
                    <h2 class="text-2xl font-bold text-stone-700 font-serif mb-6">Matriz de Acci√≥n Cr√≠tica</h2>
                    <div class="glass p-5 sm:p-8 mb-6">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-6 text-center pb-5" style="border-bottom:1px solid rgba(229,231,235,0.4);">
                            <div class="hidden sm:block"></div>
                            <div class="glass-sm p-2 text-xs font-bold uppercase tracking-wide" style="color:#991b1b;background:rgba(254,226,226,0.6);">üõ°Ô∏è Prevenci√≥n Cr√≠tica (Transformaci√≥n)</div>
                            <div class="glass-sm p-2 text-xs font-bold uppercase tracking-wide" style="color:#166534;background:rgba(220,252,231,0.6);">üå± Promoci√≥n Emancipadora (Potenciaci√≥n)</div>
                        </div>
                        <div class="space-y-8">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="glass-sm p-4 flex flex-col justify-center"><h4 class="font-bold text-amber-800 text-sm">GENERAL</h4><p class="text-xs text-stone-600">Nivel Estrat√©gico</p></div>
                                <textarea id="praxis-g-prev" class="glass-input p-3 sm:p-4 h-28 sm:h-32" placeholder="Transformaci√≥n Estructural. ¬øQu√© pol√≠ticas, leyes o modelos econ√≥micos debemos cambiar para frenar la determinaci√≥n destructiva desde la ra√≠z?" oninput="autoSave()"></textarea>
                                <textarea id="praxis-g-prom" class="glass-input p-3 sm:p-4 h-28 sm:h-32" placeholder="Institucionalizaci√≥n. ¬øC√≥mo convertir las luchas sociales y logros comunitarios en derechos permanentes o pol√≠ticas de estado?" oninput="autoSave()"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="glass-sm p-4 flex flex-col justify-center"><h4 class="font-bold text-teal-800 text-sm">PARTICULAR</h4><p class="text-xs text-stone-600">Nivel T√°ctico</p></div>
                                <textarea id="praxis-p-prev" class="glass-input p-3 sm:p-4 h-28 sm:h-32" placeholder="Organizaci√≥n y Blindaje. ¬øQu√© acciones gremiales, barriales o comunitarias pueden proteger al grupo de la exposici√≥n masiva?" oninput="autoSave()"></textarea>
                                <textarea id="praxis-p-prom" class="glass-input p-3 sm:p-4 h-28 sm:h-32" placeholder="Potenciaci√≥n de Modos de Vida. ¬øC√≥mo fortalecer la identidad, las redes de solidaridad y la cultura propia del grupo?" oninput="autoSave()"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="glass-sm p-4 flex flex-col justify-center"><h4 class="font-bold text-amber-600 text-sm">SINGULAR</h4><p class="text-xs text-stone-600">Nivel Puntual</p></div>
                                <textarea id="praxis-i-prev" class="glass-input p-3 sm:p-4 h-28 sm:h-32" placeholder="Protecci√≥n Inmediata. Acciones cl√≠nicas o cambios de conducta individual para reducir el da√±o ya encarnado." oninput="autoSave()"></textarea>
                                <textarea id="praxis-i-prom" class="glass-input p-3 sm:p-4 h-28 sm:h-32" placeholder="Empoderamiento. Educaci√≥n cr√≠tica, autoconocimiento y cuidado del cuerpo." oninput="autoSave()"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="text-center pb-8 flex justify-center gap-4">
                        <button onclick="generarReporte('praxis')" class="btn-glass">üñ®Ô∏è Descargar Plan PDF</button>
                        <button onclick="switchTab('himupac')" class="btn-primary">Ir a Metodolog√≠a HiMupAC ‚ûî</button>
                    </div>
                </div>
            </section>

            <!-- 5. HIMUPAC -->
            <section id="himupac" class="tab-content hidden pb-10">
                <div class="max-w-6xl mx-auto">
                    <!-- Config strip -->
                    <div class="glass p-4 sm:p-5 mb-5 flex flex-wrap gap-4 items-center justify-between" style="border-left:3px solid rgba(180,83,9,0.5);">
                        <div>
                            <h3 class="font-bold text-amber-900 text-lg">M√©todo HiMupAC</h3>
                            <p class="text-xs text-stone-500 mt-0.5">Historias Musicales para el Aprendizaje Colectivo ‚Äî P√°ez-Mora & Cetina-Matallana (2025)</p>
                        </div>
                        <div class="flex flex-wrap gap-3">
                            <div><label class="text-xs text-stone-600 block mb-1 font-semibold uppercase tracking-wide">Facilitador/a</label><input type="text" id="him-autor" placeholder="Nombre..." class="glass-input px-3 py-2 w-40 sm:w-52" oninput="autoSave()"></div>
                            <div><label class="text-xs text-stone-600 block mb-1 font-semibold uppercase tracking-wide">Fecha</label><input type="date" id="him-fecha" class="glass-input px-3 py-2" oninput="autoSave()"></div>
                        </div>
                    </div>

                    <div class="grid lg:grid-cols-3 gap-5 sm:gap-7 mb-8">

                        <!-- LEFT COL: Paso 1 ‚Äî Diagn√≥stico -->
                        <div class="lg:col-span-1">
                            <div class="glass p-5 sm:p-6" style="border-top:3px solid rgba(120,53,15,0.5);">
                                <h3 class="text-base font-bold text-amber-900 mb-2 pb-2" style="border-bottom:1px solid rgba(229,231,235,0.5);">1. Diagn√≥stico Territorial</h3>
                                <p class="text-xs text-stone-500 mb-3 leading-relaxed text-justify">Seleccione los procesos de la Matriz que guiar√°n la historia. Los <span class="font-bold text-red-700">Nudos Cr√≠ticos</span> (Malsanos) son los problemas que la historia debe abordar; los <span class="font-bold text-green-700">Procesos Protectores</span> son los saberes y fortalezas comunitarias que deben visibilizarse como camino de transformaci√≥n (Breilh, 2023).</p>

                                <div class="mb-3">
                                    <div class="text-xs font-bold uppercase tracking-wide mb-1.5 flex items-center gap-1.5" style="color:#be123c;">
                                        <span class="w-2 h-2 rounded-sm inline-block" style="background:#e11d48;"></span> Nudos Cr√≠ticos (Malsanos)
                                    </div>
                                    <div id="himupac-checklist-dest" class="flex flex-col gap-1 max-h-40 overflow-y-auto p-2 rounded-xl" style="background:rgba(255,241,242,0.5);border:1px solid rgba(252,165,165,0.4);"></div>
                                </div>
                                <div class="mb-4">
                                    <div class="text-xs font-bold uppercase tracking-wide mb-1.5 flex items-center gap-1.5" style="color:#15803d;">
                                        <span class="w-2 h-2 rounded-full inline-block" style="background:#16a34a;"></span> Fortalezas Comunitarias (Protectores)
                                    </div>
                                    <div id="himupac-checklist-prot" class="flex flex-col gap-1 max-h-40 overflow-y-auto p-2 rounded-xl" style="background:rgba(240,253,244,0.5);border:1px solid rgba(134,239,172,0.4);"></div>
                                </div>
                                <div class="text-xs font-bold text-stone-400 uppercase tracking-wide mb-1.5">Seleccionados para la historia:</div>
                                <div id="himupac-selected-list" class="flex flex-wrap gap-1.5 min-h-[36px] p-2 rounded-xl" style="border:1.5px dashed rgba(229,231,235,0.7);"></div>
                            </div>
                        </div>

                        <!-- RIGHT COL: Pasos 2‚Äì7 -->
                        <div class="lg:col-span-2 space-y-4 sm:space-y-5">

                            <!-- Paso 2: Fundamentaci√≥n Intercultural -->
                            <div class="glass p-5 sm:p-6" style="background:rgba(219,234,254,0.4);border-color:rgba(147,197,253,0.45);">
                                <h3 class="text-base font-bold text-blue-800 mb-2 flex items-center gap-2.5 pb-2" style="border-bottom:1px solid rgba(147,197,253,0.4);">
                                    <span class="step-badge" style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);">2</span>
                                    Fundamentaci√≥n Intercultural
                                </h3>
                                <p class="text-xs text-blue-800 mb-3 leading-relaxed">La interculturalidad cr√≠tica (Walsh, 2010) reconoce al Otro con sus diferencias y valor en s√≠ mismo, alej√°ndose de concepciones utilitaristas. No se trata de adaptar t√©cnicamente el mensaje, sino de <em>co-construirlo</em> desde el di√°logo. Identifique los saberes, pr√°cticas y cosmovisiones propias del grupo que deben estar presentes en la historia.</p>
                                <label class="text-xs font-semibold text-stone-400 uppercase tracking-wide block mb-1.5">Saberes locales y cosmovisi√≥n a integrar</label>
                                <textarea id="him-fundamentos" class="glass-input p-3 h-20" style="background:rgba(255,255,255,0.8)!important;" placeholder="Ej: Pr√°cticas de medicina tradicional, rituales comunitarios, formas propias de nombrar la enfermedad, creencias sobre el cuerpo y la salud, autoridades espirituales o l√≠deres reconocidos... ¬øQu√© saberes del territorio queremos que hablen en esta historia?" oninput="autoSave()"></textarea>
                            </div>

                            <!-- Paso 3: Sujeto / Experiencia Vicaria -->
                            <div class="glass p-5 sm:p-6" style="border-top:3px solid rgba(180,83,9,0.45);">
                                <h3 class="text-base font-bold text-amber-900 mb-2 pb-2" style="border-bottom:1px solid rgba(229,231,235,0.5);color:#1c1917;">
                                    <span class="step-badge inline-flex mr-2" style="width:28px;height:28px;font-size:0.8rem;">3</span>
                                    Sujeto ‚Äî Experiencia Vicaria
                                </h3>
                                <p class="text-xs text-stone-700 mb-3 leading-relaxed">El personaje es el eje emocional de la historia. Seg√∫n Bandura (citado en P√°ez-Mora, 2025), la <em>experiencia vicaria</em> permite que la audiencia se identifique con la situaci√≥n del personaje y aprenda desde esa empat√≠a ("Ese soy yo"). El personaje debe ser co-construido con la comunidad: preguntarles <strong>¬øc√≥mo se llamar√≠a? ¬øqu√© ropa usar√≠a? ¬øa qu√© se dedica?</strong> Incluya rasgos de la ocupaci√≥n, edad y vestuario propios del territorio.</p>
                                <div class="grid sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-semibold text-stone-400 uppercase tracking-wide mb-1.5 block">Perfil del personaje</label>
                                        <textarea id="him-personaje-perfil" class="glass-input p-3 h-28" placeholder="Nombre elegido por la comunidad, edad, ocupaci√≥n, vestuario caracter√≠stico. Describa rasgos f√≠sicos y sociales que lo sit√∫en en el territorio. Si usa IA para generar la imagen, este texto ser√° el prompt." oninput="autoSave()"></textarea>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-stone-400 uppercase tracking-wide mb-1.5 block">Vivencia del problema</label>
                                        <textarea id="him-personaje-vivencia" class="glass-input p-3 h-28" placeholder="¬øC√≥mo vive, siente y sufre este personaje el proceso malsano seleccionado? Narre desde sus emociones, no desde el diagn√≥stico cl√≠nico. Ej: 'A Lucas le cuesta respirar cuando juega, siente que su cuerpo le falla y que no puede disfrutar lo que le gusta...'" oninput="autoSave()"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Paso 4: Creaci√≥n de contenidos ‚Äî Estrategia Narrativa -->
                            <div class="glass p-5 sm:p-6" style="border-top:3px solid rgba(180,83,9,0.45);">
                                <h3 class="text-base font-bold text-amber-900 mb-2 pb-2" style="border-bottom:1px solid rgba(229,231,235,0.5);color:#1c1917;">
                                    <span class="step-badge inline-flex mr-2" style="width:28px;height:28px;font-size:0.8rem;">4</span>
                                    Creaci√≥n ‚Äî Estrategia Narrativa
                                </h3>
                                <p class="text-xs text-stone-700 mb-3 leading-relaxed">La historia debe transitar entre la identificaci√≥n del problema y la posibilidad de transformaci√≥n. El nivel de transformaci√≥n orienta el horizonte: <strong>Singular</strong> apunta a cambios en estilos de vida; <strong>Particular</strong> al fortalecimiento del tejido social y la movilizaci√≥n colectiva; <strong>General</strong> a visibilizar estructuras de poder e injusticia. Una misma historia puede operar en varios niveles simult√°neamente.</p>
                                <div class="mb-3">
                                    <label class="text-xs font-semibold text-stone-400 uppercase tracking-wide mb-1.5 block">Nivel de transformaci√≥n articulada</label>
                                    <select id="him-nivel" class="glass-input p-2.5" onchange="autoSave()">
                                        <option value="">Seleccione el nivel de impacto deseado...</option>
                                        <option value="Singular ‚Äî Estilos de vida">Singular: Cambiar estilos de vida y detecci√≥n temprana</option>
                                        <option value="Particular ‚Äî Tejido y movilizaci√≥n">Particular: Fortalecer tejido comunitario y movilizaci√≥n</option>
                                        <option value="General ‚Äî Estructura y poder">General: Visibilizar injusticias, relaciones de poder y estructuras</option>
                                        <option value="M√∫ltiples niveles articulados">M√∫ltiples niveles articulados</option>
                                    </select>
                                </div>
                                <label class="text-xs font-semibold text-stone-400 uppercase tracking-wide mb-1.5 block">Trama y desenlace</label>
                                <textarea id="him-trama" class="glass-input p-3 h-32" placeholder="Desarrolle la historia. ¬øC√≥mo el personaje vive el problema? ¬øQu√© desencadena la reflexi√≥n o el cambio? ¬øC√≥mo se organiza o conecta con otros para transformar la situaci√≥n? Evite los 'finales m√°gicos' ‚Äî el desenlace debe ser realista y situado en el territorio. Use los regionalismos, dichos y expresiones propias de la comunidad." oninput="autoSave()"></textarea>
                            </div>

                            <!-- Paso 5: Est√©tica Sonora / Adaptaci√≥n Cultural -->
                            <div class="glass p-5 sm:p-6" style="border-top:3px solid rgba(180,83,9,0.45);">
                                <h3 class="text-base font-bold text-amber-900 mb-2 pb-2" style="border-bottom:1px solid rgba(229,231,235,0.5);color:#1c1917;">
                                    <span class="step-badge inline-flex mr-2" style="width:28px;height:28px;font-size:0.8rem;">5</span>
                                    Adaptaci√≥n Cultural ‚Äî Est√©tica Sonora
                                </h3>
                                <p class="text-xs text-stone-700 mb-3 leading-relaxed">La m√∫sica act√∫a como medio de conexi√≥n emocional y cultural. Los ritmos, melod√≠as y sonidos deben ser co-construidos con la comunidad: preguntarle al grupo <em>"si esta historia fuera una canci√≥n, ¬øc√≥mo sonar√≠a? ¬øser√≠a alegre, nost√°lgica, de lucha?"</em> Use artistas locales si es posible. Las rimas asonantes o consonantes ayudan a que la letra sea memorable. Los saberes populares ‚Äî dichos, frases, palabras del territorio ‚Äî son el coraz√≥n de la adaptaci√≥n cultural (P√°ez-Mora, 2025).</p>
                                <div class="grid sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-semibold text-stone-400 uppercase tracking-wide mb-1.5 block">Ritmo, melod√≠a y sonoridad</label>
                                        <textarea id="him-ritmo" class="glass-input p-3 h-28" placeholder="¬øQu√© ritmo musical es propio de este territorio? (Bambuco, mapal√©, rap, vallenato, cumbia, trap...) ¬øSonidos ambientales que quieran incluir? ¬øLa canci√≥n ser√° alegre, de denuncia, nost√°lgica? ¬øHay artistas locales que puedan participar?" oninput="autoSave()"></textarea>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-stone-400 uppercase tracking-wide mb-1.5 block">Saberes populares, dichos y regionalismos</label>
                                        <textarea id="him-dichos" class="glass-input p-3 h-28" placeholder="Regionalismos, dichos, frases o palabras del territorio ‚Äî sin importar lo 'raras' que parezcan ‚Äî que deben aparecer en la letra. Tambi√©n costumbres, nombres propios de lugares, plantas medicinales, pr√°cticas cotidianas que den identidad a la historia. Ej: 'maluquiar', 'el fr√≠o del p√°ramo', 'ag√ºitas de la abuela'..." oninput="autoSave()"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Paso 6: Puesta en Escena -->
                            <div class="glass p-5 sm:p-6" style="border-top:3px solid rgba(180,83,9,0.45);">
                                <h3 class="text-base font-bold text-amber-900 mb-2 pb-2" style="border-bottom:1px solid rgba(229,231,235,0.5);color:#1c1917;">
                                    <span class="step-badge inline-flex mr-2" style="width:28px;height:28px;font-size:0.8rem;">6</span>
                                    Puesta en Escena ‚Äî Co-construcci√≥n
                                </h3>
                                <p class="text-xs text-stone-700 mb-3 leading-relaxed">La puesta en escena es el proceso de divulgaci√≥n con el grupo social: se presenta la pieza audiovisual a la comunidad o grupo, se escuchan sus comentarios, limitaciones y aciertos, y con esos insumos se ajusta (evoluci√≥n). No es un producto terminado sino una <em>versi√≥n en di√°logo permanente</em>. Planifique en qu√© espacio, con qui√©nes y bajo qu√© din√°mica se har√° la primera presentaci√≥n.</p>
                                <label class="text-xs font-semibold text-stone-400 uppercase tracking-wide mb-1.5 block">Estrategia de uso y primera socializaci√≥n</label>
                                <textarea id="him-puesta" class="glass-input p-3 h-24" style="background:rgba(255,255,255,0.8)!important;" placeholder="¬øD√≥nde y con qui√©nes se presentar√°? (aula, reuni√≥n comunitaria, evento cultural, consulta...) ¬øQu√© actividades acompa√±ar√°n la escucha? (grupo focal, conversatorio, encuesta de percepci√≥n...) ¬øC√≥mo se documentar√°n los comentarios para la evoluci√≥n del producto?" oninput="autoSave()"></textarea>
                            </div>

                            <!-- Paso 7: Publicaci√≥n -->
                            <div class="glass p-5 sm:p-6" style="background:rgba(240,253,244,0.45);border-color:rgba(134,239,172,0.45);">
                                <h3 class="text-base font-bold text-green-800 mb-2 pb-2 flex items-center gap-2.5" style="border-bottom:1px solid rgba(134,239,172,0.4);">
                                    <span class="step-badge" style="background:linear-gradient(135deg,#16a34a,#15803d);">7</span>
                                    Publicaci√≥n y Difusi√≥n
                                </h3>
                                <p class="text-xs text-green-800 mb-3 leading-relaxed">Luego de la evoluci√≥n participativa, la pieza audiovisual se publica para ampliar su alcance. Las piezas pueden funcionar como <em>voz del colectivo</em> en la lucha por justicia social y la visibilizaci√≥n de inequidades (P√°ez-Mora, 2025). Defina los canales y la estrategia de difusi√≥n considerando el alcance deseado y los recursos disponibles.</p>
                                <div class="grid sm:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs font-semibold text-stone-400 uppercase tracking-wide mb-1.5 block">Canales de publicaci√≥n</label>
                                        <textarea id="him-publicacion-canales" class="glass-input p-3 h-20" style="background:rgba(255,255,255,0.8)!important;" placeholder="Redes sociales (TikTok, Instagram, YouTube, Facebook), emisoras de radio local, eventos culturales o acad√©micos, consultorios, salas de espera, aulas, WhatsApp comunitario, carteleras digitales..." oninput="autoSave()"></textarea>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-stone-400 uppercase tracking-wide mb-1.5 block">Estrategia y alcance esperado</label>
                                        <textarea id="him-publicacion-estrategia" class="glass-input p-3 h-20" style="background:rgba(255,255,255,0.8)!important;" placeholder="¬øQu√© p√∫blico se quiere impactar? ¬øQu√© acciones complementar√°n la publicaci√≥n? ¬øLa pieza puede convertirse en insumo para pol√≠ticas p√∫blicas, debates comunitarios o incidencia pol√≠tica?" oninput="autoSave()"></textarea>
                                    </div>
                                </div>
                            </div>

                        </div><!-- /right col -->
                    </div><!-- /grid -->

                    <div class="text-center pb-8 flex flex-wrap justify-center gap-3">
                        <button onclick="generarReporte('himupac')" class="btn-glass">üìù Generar Propuesta PDF</button>
                        <button onclick="switchTab('evaluacion')" class="btn-primary">Ir a Evaluaci√≥n ‚ûî</button>
                    </div>
                </div>
            </section>

            <!-- 6. EVALUACI√ìN -->
            <section id="evaluacion" class="tab-content hidden pb-10">
                <div class="max-w-5xl mx-auto">
                    <div class="glass p-5 sm:p-7 mb-6" style="background:rgba(236,253,245,0.5);border-color:rgba(110,231,183,0.5);">
                        <div class="flex gap-3 items-start">
                            <span class="text-2xl flex-shrink-0">üìä</span>
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold mb-1" style="color:#14532d;">Evaluaci√≥n del Proceso HiMupAC</h2>
                                <p class="text-sm leading-relaxed" style="color:#14532d;">La evaluaci√≥n es una fase continua y flexible que se adapta al contexto de cada territorio. Seg√∫n P√°ez-Mora & Cetina-Matallana (2025), se sugiere dialogar sobre el efecto de la estrategia, la percepci√≥n de cambio social y la receptividad de la comunidad. Puede medir diferentes tipos de indicadores dependiendo de la experiencia del equipo y los recursos disponibles.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Indicadores din√°micos desde la matriz -->
                    <div class="glass p-5 sm:p-6 mb-5" style="border-top:3px solid rgba(5,150,105,0.5);">
                        <h3 class="text-base font-bold text-green-800 mb-3 pb-2" style="border-bottom:1px solid rgba(229,231,235,0.5);">Indicadores Sugeridos desde la Matriz</h3>
                        <p class="text-xs text-stone-700 mb-4 leading-relaxed">Con base en los procesos malsanos registrados en su Matriz de Determinaci√≥n Social, el sistema sugiere indicadores de evaluaci√≥n para medir el impacto de la estrategia HiMupAC. Edite o complemente seg√∫n su contexto.</p>
                        <div id="eval-dynamic-indicators" class="space-y-2"></div>
                        <p class="text-xs text-stone-400 mt-3 italic" id="eval-no-data" style="display:none;">Complete primero la Matriz de Procesos (Tab 2) para generar indicadores autom√°ticos.</p>
                    </div>

                    <!-- Evaluaci√≥n cualitativa -->
                    <div class="grid sm:grid-cols-2 gap-5 mb-5">
                        <div class="glass p-5">
                            <h4 class="text-sm font-bold uppercase tracking-wide mb-3 pb-2" style="color:#292524;" style="border-bottom:1px solid rgba(229,231,235,0.5);">üó£ Percepci√≥n Comunitaria</h4>
                            <p class="text-xs text-stone-700 mb-3 leading-relaxed">Resultados de grupos focales, entrevistas o conversatorios despu√©s de la puesta en escena. ¬øC√≥mo reson√≥ la historia? ¬øQu√© emociones gener√≥? ¬øReconocieron su realidad en el personaje?</p>
                            <textarea id="eval-percepcion" class="glass-input p-3 h-28" placeholder="Describa las reacciones de la comunidad al ver/escuchar la pieza. Incluya citas textuales si las tiene (sin nombres propios). ¬øSe identificaron con el personaje? ¬øQu√© cambiar√≠an?" oninput="autoSave()"></textarea>
                        </div>
                        <div class="glass p-5">
                            <h4 class="text-sm font-bold uppercase tracking-wide mb-3 pb-2" style="color:#292524;" style="border-bottom:1px solid rgba(229,231,235,0.5);">üîÑ Cambio Percibido</h4>
                            <p class="text-xs text-stone-700 mb-3 leading-relaxed">Valoraci√≥n del alcance de la estrategia en t√©rminos de movilizaci√≥n, reflexi√≥n cr√≠tica o acci√≥n colectiva. ¬øLa historia abri√≥ nuevas discusiones? ¬øGener√≥ organizaci√≥n comunitaria?</p>
                            <textarea id="eval-cambio" class="glass-input p-3 h-28" placeholder="¬øSe observaron cambios en la discusi√≥n sobre el problema? ¬øEl grupo comenz√≥ a hablar de causas estructurales, no solo s√≠ntomas? ¬øHay indicios de movilizaci√≥n, demanda de derechos o acci√≥n colectiva?" oninput="autoSave()"></textarea>
                        </div>
                        <div class="glass p-5">
                            <h4 class="text-sm font-bold uppercase tracking-wide mb-3 pb-2" style="color:#292524;" style="border-bottom:1px solid rgba(229,231,235,0.5);">üéØ Indicadores Cuantitativos</h4>
                            <p class="text-xs text-stone-700 mb-3 leading-relaxed">M√©tricas de alcance o proceso que puedan ser √∫tiles para reportes institucionales o acad√©micos. Adapte a sus recursos.</p>
                            <textarea id="eval-cuantitativo" class="glass-input p-3 h-28" placeholder="Ej: N√∫mero de personas que vieron la pieza, reproducciones digitales, porcentaje que identific√≥ el problema principal, n√∫mero de conversatorios realizados, grupos de WhatsApp donde se comparti√≥..." oninput="autoSave()"></textarea>
                        </div>
                        <div class="glass p-5">
                            <h4 class="text-sm font-bold uppercase tracking-wide mb-3 pb-2" style="color:#292524;" style="border-bottom:1px solid rgba(229,231,235,0.5);">üîß Evoluci√≥n de la Pieza</h4>
                            <p class="text-xs text-stone-700 mb-3 leading-relaxed">Con base en la puesta en escena, identifique qu√© ajustes requiere la historia antes de su publicaci√≥n final. La evoluci√≥n es parte esencial del m√©todo (P√°ez-Mora, 2025).</p>
                            <textarea id="eval-evolucion" class="glass-input p-3 h-28" placeholder="¬øQu√© palabras, im√°genes o significados resultaron confusos para la comunidad? ¬øQu√© debe ajustarse antes de publicar? ¬øHay elementos culturales que faltaron o que deben modificarse?" oninput="autoSave()"></textarea>
                        </div>
                    </div>

                    <!-- Reflexi√≥n final -->
                    <div class="glass p-5 mb-6" style="background:rgba(255,251,235,0.55);border-color:rgba(253,211,77,0.4);">
                        <h4 class="text-sm font-bold text-amber-800 uppercase tracking-wide mb-3 pb-2" style="border-bottom:1px solid rgba(253,211,77,0.3);">üí¨ Reflexi√≥n Cr√≠tica del Proceso</h4>
                        <p class="text-xs text-amber-900 mb-3 leading-relaxed">Fals-Borda (2015) resalta la importancia de una <em>praxis cr√≠tica sentipensante</em> en las intervenciones sociales. Esta reflexi√≥n permite al equipo evaluar si el proceso fue genuinamente participativo o si reprodujo din√°micas hegem√≥nicas. Sea honesto/a ‚Äî esto fortalece futuras aplicaciones.</p>
                        <textarea id="eval-reflexion" class="glass-input p-3 h-24" style="background:rgba(255,255,255,0.8)!important;" placeholder="¬øEl proceso de construcci√≥n fue realmente participativo o hubo imposici√≥n t√©cnica? ¬øLa comunidad se apropi√≥ del producto o lo percibe como externo? ¬øQu√© aprendizajes deja este proceso para futuras aplicaciones de HiMupAC?" oninput="autoSave()"></textarea>
                    </div>

                    <div class="text-center pb-8 flex flex-wrap justify-center gap-3">
                        <button onclick="generarReporte('evaluacion')" class="btn-glass">üìã Generar Informe PDF</button>
                        <button onclick="switchTab('instrucciones')" class="btn-primary">‚Üê Volver al inicio</button>
                    </div>
                </div>
            </section>
        </main>
    
    <!-- APP FOOTER -->
    <footer class="app-footer">
        <p>Dise√±o elaborado por <strong>Carlos Duv√°n P√°ez Mora</strong> ‚Äî Docente Maestr√≠a en Salud P√∫blica, Fundaci√≥n Universitaria √Årea Andina, Bogot√°.</p>
        <p>Dise√±o apoyado por IA &nbsp;|&nbsp; Basado en la obra de Jaime Breilh (2023) y el m√©todo HiMupAC de P√°ez-Mora & Cetina-Matallana (2025)</p>
    </footer>
</div>

    <script>
    // ============================================================
    // DATOS
    // ============================================================
    let matrixData = {
        sus: { g: [], p: [], i: [] },
        sob: { g: [], p: [], i: [] },
        sol: { g: [], p: [], i: [] },
        seg: { g: [], p: [], i: [] }
    };
    let himupacSelection = [];
    let myRadarChart = null;
    const nodeNames = { sus: 'Sustentabilidad', sob: 'Soberan√≠a', sol: 'Solidaridad', seg: 'Seguridad' };
    const nodeColors = { sus: '#059669', sob: '#b91c1c', sol: '#d97706', seg: '#0369a1' };

    // ============================================================
    // FIX 1: CONSTRUCCI√ìN DEL DOM SIN document.write()
    // ============================================================
    const sectionDefs = [
        {
            id: 'sus', t: 'üå± Sustentabilidad', c: 'border-emerald-600', tc: 'text-emerald-800',
            g: 'General: ¬øQu√© modelo de acumulaci√≥n predomina? (Ej: Extractivismo minero, monocultivo, despojo). ¬øQu√© leyes protegen o vulneran la naturaleza?',
            p: 'Particular: ¬øEl grupo vive cerca de fuentes t√≥xicas? ¬øTienen acceso soberano al agua? ¬øPr√°cticas de reciclaje?',
            i: 'Singular: ¬øC√≥mo se encarnan estos procesos en los cuerpos? ¬øSignos de intoxicaci√≥n, enfermedades respiratorias, d√©rmicas? ¬øCarga biol√≥gica alterada por el ambiente?'
        },
        {
            id: 'sob', t: '‚úä Soberan√≠a', c: 'border-red-700', tc: 'text-red-800',
            g: 'General: ¬øDependencia econ√≥mica extranjera? ¬øP√©rdida de soberan√≠a alimentaria? ¬øImposici√≥n tecnol√≥gica?',
            p: 'Particular: ¬øCapacidad de autogesti√≥n? ¬øSindicatos o gremios fuertes? ¬øControl sobre medios de trabajo?',
            i: 'Singular: ¬øLa persona conoce sus derechos? ¬øTiene capacidad de decisi√≥n aut√≥noma o vive alienada del sistema productivo?'
        },
        {
            id: 'sol', t: 'ü§ù Solidaridad', c: 'border-amber-600', tc: 'text-amber-800',
            g: 'General: ¬øPredomina el individualismo/competencia o la cooperaci√≥n? ¬øPol√≠ticas de lo com√∫n?',
            p: 'Particular: ¬øRedes de apoyo, mingas? ¬øO violencia intrafamiliar y discriminaci√≥n?',
            i: 'Singular: ¬øC√≥mo se expresa la soledad, angustia, aislamiento en la corporalidad? ¬øQu√© dice la autoestima e identidad cultural?'
        },
        {
            id: 'seg', t: 'üõ°Ô∏è Seguridad Integral', c: 'border-blue-600', tc: 'text-blue-800',
            g: 'General: ¬øSalud como derecho o negocio? ¬øSistemas de pensiones? ¬øEstado de bienestar?',
            p: 'Particular: ¬øTrabajo seguro o precario? ¬øVivienda digna? ¬øSeguridad alimentaria grupal?',
            i: 'Singular: ¬øLa persona tiene acceso real (no solo formal) a tratamientos? ¬øTraumas f√≠sicos acumulados? ¬øEstado nutricional?'
        }
    ];

    function buildMatrixPanels() {
        const container = document.getElementById('matrix-panels');
        container.innerHTML = '';
        const topColors = { sus:'rgba(5,150,105,0.55)', sob:'rgba(185,28,28,0.55)', sol:'rgba(217,119,6,0.55)', seg:'rgba(3,105,161,0.55)' };
        sectionDefs.forEach(s => {
            const panel = document.createElement('div');
            panel.className = 'glass p-5 sm:p-6';
            panel.style.borderTop = `3px solid ${topColors[s.id]}`;
            const dimLabels = { g: 'GENERAL', p: 'PARTICULAR', i: 'SINGULAR (Fenotipo Social)' };
            const tc = {sus:'color:#065f46',sob:'color:#7f1d1d',sol:'color:#78350f',seg:'color:#0c4a6e'}[s.id]; let innerHtml = `<h3 class="font-bold text-base mb-5 uppercase tracking-widest flex items-center gap-2" style="${tc}">${s.t}</h3><div class="space-y-5">`;
            ['g', 'p', 'i'].forEach(d => {
                innerHtml += `
                    <div>
                        <label class="text-xs font-bold text-stone-400 uppercase tracking-widest block mb-1.5">${dimLabels[d]}</label>
                        <div id="list-${s.id}-${d}" class="mb-2 space-y-1"></div>
                        <textarea id="input-${s.id}-${d}" class="glass-input p-3 h-20" placeholder="${s[d]}"></textarea>
                        <div class="flex justify-end gap-3 mt-2">
                            <button onclick="addProcess('${s.id}-${d}','destructive')" class='btn-tag btn-tag-d'>Malsano +</button>
                            <button onclick="addProcess('${s.id}-${d}','protective')" class='btn-tag btn-tag-p'>Protector +</button>
                        </div>
                    </div>`;
            });
            innerHtml += '</div>';
            panel.innerHTML = innerHtml;
            container.appendChild(panel);
        });
    }

    // ============================================================
    // FIX 2: GESTI√ìN DE PROCESOS CON √çNDICES ESTABLES
    // Se usa splice para eliminar realmente, no poner null.
    // El √≠ndice se busca por referencia al objeto, no por posici√≥n.
    // ============================================================
    function addProcess(k, type) {
        const [n, d] = k.split('-');
        const inputEl = document.getElementById(`input-${k}`);
        const v = inputEl.value.trim();
        if (!v) return;
        const item = { text: v, type: type, id: Date.now() + Math.random() };
        matrixData[n][d].push(item);
        renderProcessItem(document.getElementById(`list-${k}`), item, n, d);
        inputEl.value = '';
        autoSave();
    }

    function renderProcessItem(container, item, n, d) {
        const el = document.createElement('div');
        el.className = `process-item ${item.type === 'destructive' ? 'item-destructive' : 'item-protective'}`;el.style.fontSize='0.82rem';
        el.dataset.itemId = item.id;
        el.innerHTML = `<span class="flex-grow">${item.text}</span><button onclick="remProc('${n}','${d}',${item.id},this)" class="delete-btn">‚úï</button>`;
        container.appendChild(el);
    }

    function remProc(n, d, itemId, btn) {
        // FIX: splice real, no null
        const idx = matrixData[n][d].findIndex(x => x && x.id === itemId);
        if (idx !== -1) matrixData[n][d].splice(idx, 1);
        btn.parentElement.remove();
        autoSave();
    }

    // ============================================================
    // UI
    // ============================================================
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(e => { e.classList.add('hidden'); e.classList.remove('block'); });
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.nav-pill').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + id).classList.add('active');
        if (id === 'visualizar') { renderTable(); renderCircles(); }
        if (id === 'himupac') renderHimupacSel();
        if (id === 'evaluacion') renderEvalDynamic();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ============================================================
    // GR√ÅFICOS
    // ============================================================
    function renderTable() {
        const t = document.getElementById('territory-input').value;
        document.getElementById('display-territory').innerText = t ? `Territorio: ${t}` : "Territorio: No definido";
        const dims = { g: 'General', p: 'Particular', i: 'Singular (Fenotipo)' };
        let h = `<table class="synthesis-table"><thead><tr><th>Dimensi√≥n</th><th>üå± Sus</th><th>‚úä Sob</th><th>ü§ù Sol</th><th>üõ°Ô∏è Seg</th></tr></thead><tbody>`;
        ['g', 'p', 'i'].forEach(d => {
            h += `<tr><td class="row-header">${dims[d]}</td>`;
            ['sus', 'sob', 'sol', 'seg'].forEach(n => {
                h += `<td>`;
                matrixData[n][d].forEach(x => {
                    h += `<span class="tag ${x.type === 'destructive' ? 'tag-crit' : 'tag-prot'}">${x.text}</span><br>`;
                });
                h += `</td>`;
            });
            h += `</tr>`;
        });
        h += `</tbody></table>`;
        document.getElementById('table-container').innerHTML = h;

        // Radar
        const ctx = document.getElementById('radarChart');
        if (ctx) {
            let dD = [], dP = [];
            ['sus', 'sob', 'sol', 'seg'].forEach(n => {
                let d = 0, p = 0;
                ['g', 'p', 'i'].forEach(dim => matrixData[n][dim].forEach(x => { x.type === 'destructive' ? d++ : p++; }));
                dD.push(d); dP.push(p);
            });
            if (myRadarChart) myRadarChart.destroy();
            myRadarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Sus', 'Sob', 'Sol', 'Seg'],
                    datasets: [
                        { label: 'Destructivos', data: dD, backgroundColor: 'rgba(220,38,38,0.2)', borderColor: '#dc2626' },
                        { label: 'Protectores', data: dP, backgroundColor: 'rgba(22,163,74,0.2)', borderColor: '#16a34a' }
                    ]
                },
                options: { scales: { r: { suggestedMin: 0 } } }
            });
        }
    }

    // FIX: posiciones deterministas (semilla fija por √≠ndice) para reproducibilidad en PDF
    function seededPos(seed, min, max) {
        const x = Math.sin(seed) * 10000;
        return min + (x - Math.floor(x)) * (max - min);
    }

    function renderCircles() {
        const c = document.getElementById('subsumption-graphic');
        c.innerHTML = `
            <div class="circle-general">
                <div class="circle-label">G</div>
                <div id="rg" style="position:absolute;width:100%;height:100%;border-radius:50%;"></div>
                <div class="circle-particular">
                    <div class="circle-label">P</div>
                    <div id="rp" style="position:absolute;width:100%;height:100%;border-radius:50%;"></div>
                    <div class="circle-individual">
                        <div class="circle-label">S</div>
                        <div id="ri" style="position:absolute;width:100%;height:100%;border-radius:50%;"></div>
                    </div>
                </div>
            </div>`;

        const fill = (dim, containerId, minR, maxR) => {
            let seed = 0;
            ['sus', 'sob', 'sol', 'seg'].forEach(n => {
                matrixData[n][dim].forEach(x => {
                    seed++;
                    const angle = seededPos(seed * 7, 0, Math.PI * 2);
                    const r = seededPos(seed * 13, minR, maxR);
                    const dot = document.createElement('div');
                    dot.className = 'sub-tag';
                    dot.style.backgroundColor = nodeColors[n];
                    if (x.type === 'destructive') { dot.style.borderRadius = '2px'; }
                    dot.style.border = '1px solid white';
                    dot.style.left = `calc(50% + ${Math.cos(angle) * r}px)`;
                    dot.style.top = `calc(50% + ${Math.sin(angle) * r}px)`;
                    dot.style.transform = 'translate(-50%, -50%)';
                    dot.innerHTML = `<span class="tooltip">${x.text}</span>`;
                    document.getElementById(containerId).appendChild(dot);
                });
            });
        };
        fill('i', 'ri', 10, 45);
        fill('p', 'rp', 65, 110);
        fill('g', 'rg', 130, 175);
    }

    // ============================================================
    // HIMUPAC
    // ============================================================
    // himupacSelection stores {id, type} objects now
    function renderHimupacSel() {
        const ldest = document.getElementById('himupac-checklist-dest');
        const lprot = document.getElementById('himupac-checklist-prot');
        if (!ldest || !lprot) return;
        ldest.innerHTML = ''; lprot.innerHTML = '';
        let hasDest = false, hasProt = false;

        ['sus', 'sob', 'sol', 'seg'].forEach(n => ['g', 'p', 'i'].forEach(d => {
            matrixData[n][d].forEach(x => {
                const isDest = x.type === 'destructive';
                const container = isDest ? ldest : lprot;
                if (isDest) hasDest = true; else hasProt = true;
                const selObj = himupacSelection.find(s => s.id === x.id);
                const sel = !!selObj;
                const el = document.createElement('div');
                el.className = `selectable-item p-2 text-xs mb-1 ${sel ? 'selected' : ''}`;
                el.style.borderLeft = isDest ? '3px solid #e11d48' : '3px solid #16a34a';
                el.style.background = sel ? (isDest ? 'rgba(255,247,237,0.85)' : 'rgba(240,253,244,0.85)') : 'rgba(255,255,255,0.5)';
                el.innerText = x.text;
                el.onclick = () => {
                    const idx = himupacSelection.findIndex(s => s.id === x.id);
                    if (idx < 0) himupacSelection.push({id: x.id, type: x.type, text: x.text});
                    else himupacSelection.splice(idx, 1);
                    renderHimupacSel();
                    autoSave();
                };
                container.appendChild(el);
            });
        }));
        if (!hasDest) ldest.innerHTML = '<div class="text-xs text-stone-400 text-center py-3 italic">Sin procesos malsanos a√∫n.</div>';
        if (!hasProt) lprot.innerHTML = '<div class="text-xs text-stone-400 text-center py-3 italic">Sin procesos protectores a√∫n.</div>';

        const sc = document.getElementById('himupac-selected-list');
        sc.innerHTML = '';
        himupacSelection.forEach(sel => {
            if (!sel || !sel.text) return;
            const s = document.createElement('span');
            const isDest = sel.type === 'destructive';
            s.className = 'him-chip';
            s.style.background = isDest ? 'rgba(255,241,242,0.9)' : 'rgba(240,253,244,0.9)';
            s.style.borderColor = isDest ? 'rgba(225,29,72,0.4)' : 'rgba(22,163,74,0.4)';
            s.style.color = isDest ? '#9f1239' : '#14532d';
            const icon = isDest ? 'üî¥' : 'üü¢';
            s.innerHTML = `${icon} ${sel.text.substring(0,26)}${sel.text.length>26?'‚Ä¶':''} <span class="close">‚úï</span>`;
            s.querySelector('.close').onclick = () => {
                himupacSelection = himupacSelection.filter(x => x.id !== sel.id);
                renderHimupacSel();
                autoSave();
            };
            sc.appendChild(s);
        });
    }

    // ============================================================
    // SISTEMA DE EXPORTACI√ìN ‚Äî ventana nueva con HTML aut√≥nomo
    // No depende de Tailwind, @media print, overlays ni canvas.
    // Abre una pesta√±a limpia con estilos inline y dispara window.print().
    // ============================================================

    // CSS base compartido para todos los PDF
    const PDF_BASE_CSS = `
        * { box-sizing: border-box; margin: 0; padding: 0; }
        @page { margin: 1.5cm; size: A4; }
        @media print { * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } }
        body { font-family: Georgia, 'Times New Roman', serif; color: #1c1917; background: white; font-size: 11pt; line-height: 1.6; }
        h1, h2, h3, h4 { font-family: Georgia, serif; font-weight: bold; }
        .page { max-width: 900px; margin: 0 auto; padding: 20px; }
        .header { border-bottom: 4px solid #78350f; padding-bottom: 16px; margin-bottom: 24px; }
        .header h1 { font-size: 22pt; color: #78350f; }
        .header .sub { font-size: 10pt; color: #78716c; font-style: italic; }
        .header .meta { font-size: 9pt; color: #57534e; margin-top: 6px; }
        .section-title { font-size: 9pt; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #57534e; margin-bottom: 6px; margin-top: 18px; border-bottom: 1px solid #e5e7eb; padding-bottom: 4px; }
        .content-box { background: #f9f9f8; border: 1px solid #e5e7eb; border-radius: 4px; padding: 12px; margin-top: 6px; min-height: 36px; font-size: 10.5pt; white-space: pre-wrap; word-break: break-word; }
        .content-box.amber { background: #fffbeb; border-color: #fcd34d; }
        .content-box.red { background: #fff1f2; border-color: #fca5a5; }
        .content-box.green { background: #f0fdf4; border-color: #86efac; }
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 8px; }
        .three-col { display: grid; grid-template-columns: 160px 1fr 1fr; gap: 12px; margin-top: 8px; }
        .label-col { background: #f5f5f4; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px 12px; }
        .label-col h4 { font-size: 10pt; color: #78350f; margin-bottom: 2px; }
        .label-col p { font-size: 8.5pt; color: #78716c; }
        .chip { display: inline-block; background: #fff7ed; border: 1px solid #f97316; color: #9a3412; border-radius: 20px; padding: 3px 10px; font-size: 9pt; margin: 3px; font-weight: bold; }
        .chip-red { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; border-radius: 4px; }
        .chip-green { background: #dcfce7; color: #166534; border: 1px solid #86efac; border-radius: 4px; }
        .tag-row { margin-top: 4px; }
        .footer { margin-top: 40px; padding-top: 12px; border-top: 1px solid #e5e7eb; text-align: center; font-size: 8pt; color: #a8a29e; }
        .divider { border: none; border-top: 1px solid #e5e7eb; margin: 20px 0; }
        .notice { background: #fffbeb; border-left: 4px solid #d97706; padding: 10px 14px; border-radius: 0 4px 4px 0; margin: 12px 0; font-size: 9.5pt; }
        .notice strong { color: #92400e; }
        table { width: 100%; border-collapse: collapse; margin-top: 8px; font-size: 9.5pt; }
        th { background: #fff7ed; padding: 8px 10px; text-align: left; border-bottom: 2px solid #ea580c; color: #9a3412; font-weight: bold; font-size: 8.5pt; text-transform: uppercase; }
        td { padding: 8px 10px; border-bottom: 1px solid #f3f4f6; vertical-align: top; }
        td.row-h { font-weight: bold; color: #78350f; background: #fafaf9; border-right: 1px solid #e5e7eb; white-space: nowrap; }
        .no-break { break-inside: avoid; }
    `;

    function openPrintWindow(htmlContent) {
        const w = window.open('', '_blank', 'width=900,height=700');
        if (!w) { alert('Permite ventanas emergentes para generar el PDF.'); return; }
        w.document.open();
        w.document.write(`<!DOCTYPE html><html lang="es"><head>
            <meta charset="UTF-8">
            <title>Informe Epidemiolog√≠a Cr√≠tica & HiMupAC</title>
            <style>${PDF_BASE_CSS}</style>
        </head><body>${htmlContent}
        <script>
            window.addEventListener('load', function() {
                setTimeout(function() { window.print(); }, 600);
            });
        <\/script>
        </body></html>`);
        w.document.close();
    }

    // --- S√çNTESIS ---
    function exportToPDF() {
        const territory = document.getElementById('territory-input').value || 'No definido';

        // Tabla de procesos
        const dims = { g: 'General', p: 'Particular', i: 'Singular (Fenotipo)' };
        const nodeLabels = { sus: 'üå± Sus', sob: '‚úä Sob', sol: 'ü§ù Sol', seg: 'üõ°Ô∏è Seg' };
        let tableRows = '';
        ['g', 'p', 'i'].forEach(d => {
            let cells = `<td class="row-h">${dims[d]}</td>`;
            ['sus', 'sob', 'sol', 'seg'].forEach(n => {
                const items = matrixData[n][d];
                cells += `<td>${items.length ? items.map(x =>
                    `<span class="chip ${x.type === 'destructive' ? 'chip-red' : 'chip-green'}" style="display:inline-block;margin:2px;padding:2px 7px;font-size:8.5pt;">${escHtml(x.text)}</span>`
                ).join('') : '<span style="color:#ccc;font-style:italic;font-size:8pt;">‚Äî</span>'}</td>`;
            });
            tableRows += `<tr>${cells}</tr>`;
        });

        // Diagrama de subsunci√≥n como SVG puro (sin position:absolute)
        const svgCircles = buildSubsumptionSVG();

        // Radar como imagen base64
        const radarImg = getRadarAsImage();

        // Conteos para la lectura
        let totalDest = 0, totalProt = 0;
        ['sus','sob','sol','seg'].forEach(n => ['g','p','i'].forEach(d => {
            matrixData[n][d].forEach(x => { x.type==='destructive' ? totalDest++ : totalProt++; });
        }));
        const balance = totalDest === 0 && totalProt === 0 ? 'Sin datos registrados.' :
            totalDest > totalProt ? `Predominio de procesos DESTRUCTIVOS (${totalDest} vs ${totalProt} protectores). Metabolismo social deteriorado.` :
            totalProt > totalDest ? `Predominio de procesos PROTECTORES (${totalProt} vs ${totalDest} destructivos). Resistencia social activa.` :
            `Balance equilibrado (${totalDest} destructivos / ${totalProt} protectores).`;

        const html = `<div class="page">
            <div class="header">
                <h1>Matriz de Procesos Cr√≠ticos</h1>
                <p class="sub">Herramienta de Epidemiolog√≠a Cr√≠tica ‚Äî Determinaci√≥n Social de la Salud</p>
                <p class="meta">Territorio: <strong>${escHtml(territory)}</strong> &nbsp;|&nbsp; Modelo Dial√©ctico: Basado en la obra de Jaime Breilh, 2023 &nbsp;|&nbsp; Instrumento: P√°ez-Mora & Cetina-Matallana (2025)</p>
            </div>

            <div class="section-title">1. Tabla de Procesos Cr√≠ticos por Dominio y Dimensi√≥n</div>
            <table>
                <thead><tr><th>Dimensi√≥n</th><th>üå± Sustentabilidad</th><th>‚úä Soberan√≠a</th><th>ü§ù Solidaridad</th><th>üõ°Ô∏è Seguridad</th></tr></thead>
                <tbody>${tableRows}</tbody>
            </table>
            <p style="font-size:8pt;color:#78716c;margin-top:6px;">
                <span style="background:#fee2e2;border:1px solid #fca5a5;padding:1px 6px;border-radius:3px;font-size:8pt;">‚ñ† Malsano/Destructivo</span> &nbsp;
                <span style="background:#dcfce7;border:1px solid #86efac;padding:1px 6px;border-radius:3px;font-size:8pt;">‚ñ† Protector/Emancipador</span>
            </p>

            <hr class="divider">

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:8px;" class="no-break">
                <div>
                    <div class="section-title">2. Balance de Fuerzas (Radar)</div>
                    ${radarImg ? `<img src="${radarImg}" style="width:100%;max-width:320px;display:block;margin:8px auto;" alt="Radar de fuerzas"/>` : '<p style="color:#aaa;font-style:italic;font-size:9pt;padding:20px;text-align:center;">Sin datos suficientes para el radar.</p>'}
                    <div class="notice" style="margin-top:8px;">
                        <strong>Lectura Cr√≠tica (Metabolismo Social):</strong>
                        El radar visualiza la tensi√≥n dial√©ctica entre vida y muerte en el territorio.
                        El √°rea <strong style="color:#dc2626;">ROJA</strong> indica metabolismo destructivo;
                        el √°rea <strong style="color:#16a34a;">VERDE</strong> representa resistencia social.
                        <br><br><strong>Balance actual:</strong> ${balance}
                    </div>
                </div>
                <div>
                    <div class="section-title">3. Subsunci√≥n Dial√©ctica (Jerarqu√≠a)</div>
                    <div style="text-align:center;margin:8px 0;">${svgCircles}</div>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:8px 0;font-size:8.5pt;">
                        <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#059669;"></span> Sustentabilidad</span>
                        <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#b91c1c;"></span> Soberan√≠a</span>
                        <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#d97706;"></span> Solidaridad</span>
                        <span><span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#0369a1;"></span> Seguridad</span>
                        <span><span style="display:inline-block;width:10px;height:10px;border-radius:3px;background:#666;"></span> Cuadrado = Destructivo</span>
                    </div>
                    <div class="notice">
                        <strong>Lectura Cr√≠tica (Jerarqu√≠a de Determinaci√≥n):</strong>
                        No somos individuos aislados. El c√≠rculo <strong>General</strong> (pol√≠ticas, modelo econ√≥mico)
                        envuelve y determina al c√≠rculo <strong>Particular</strong> (modos de vida grupales),
                        que condiciona lo <strong>Singular</strong> (cuerpo, estilos de vida).
                        Los puntos indican d√≥nde se concentran los problemas de cada categor√≠a.
                    </div>
                </div>
            </div>

            <div class="footer">Epidemiolog√≠a Cr√≠tica ‚Äî Instrumento de Determinaci√≥n Social &amp; HiMupAC &nbsp;|&nbsp; P√°ez-Mora &amp; Cetina-Matallana (2025) &nbsp;|&nbsp; Basado en Jaime Breilh</div>
        </div>`;
        openPrintWindow(html);
    }

    // --- PRAXIS ---
    function generarReporte(tipo) {
        if (tipo === 'praxis') exportPraxis();
        else if (tipo === 'evaluacion') exportEvaluacion();
        else exportHimupac();
    }
    // ============================================================
    // EVALUACI√ìN ‚Äî indicadores din√°micos desde la matriz
    // ============================================================
    function renderEvalDynamic() {
        const container = document.getElementById('eval-dynamic-indicators');
        const noData = document.getElementById('eval-no-data');
        container.innerHTML = '';
        let total = 0;
        ['sus','sob','sol','seg'].forEach(n => ['g','p','i'].forEach(d => { total += matrixData[n][d].filter(x=>x.type==='destructive').length; }));
        if (total === 0) { noData.style.display = 'block'; return; }
        noData.style.display = 'none';
        const nodeLabels = { sus:'Sustentabilidad', sob:'Soberan√≠a', sol:'Solidaridad', seg:'Seguridad' };
        const dimLabels = { g:'General', p:'Particular', i:'Singular' };
        let idx = 0;
        ['sus','sob','sol','seg'].forEach(n => {
            ['g','p','i'].forEach(d => {
                matrixData[n][d].filter(x=>x.type==='destructive').forEach(x => {
                    idx++;
                    const div = document.createElement('div');
                    div.className = 'glass-sm p-3';
                    div.style.background = 'rgba(255,255,255,0.65)';
                    div.innerHTML = `
                        <div class="flex items-start gap-2 mb-1.5">
                            <span class="text-xs font-bold px-2 py-0.5 rounded-full flex-shrink-0" style="background:rgba(254,226,226,0.8);color:#991b1b;">I.${idx}</span>
                            <span class="text-xs font-semibold text-stone-600">Proceso: <em>${escHtml(x.text)}</em> <span class="text-stone-400">(${nodeLabels[n]} ‚Äî ${dimLabels[d]})</span></span>
                        </div>
                        <div>
                            <label class="text-xs text-stone-400 uppercase tracking-wide block mb-1">Indicador de seguimiento</label>
                            <input type="text" id="eval-ind-${x.id}" class="glass-input px-3 py-1.5 text-xs" placeholder="Ej: % de la comunidad que identifica este proceso como determinante de su salud..." value="" oninput="autoSave()">
                        </div>`;
                    container.appendChild(div);
                    // restore if saved
                    const saved = (evalIndicators || {})[x.id];
                    if (saved) div.querySelector(`#eval-ind-${x.id}`).value = saved;
                });
            });
        });
    }

    let evalIndicators = {};

    function exportEvaluacion() {
        // collect dynamic indicators
        let indicatorsHtml = '';
        let idx = 0;
        const nodeLabels = { sus:'Sustentabilidad', sob:'Soberan√≠a', sol:'Solidaridad', seg:'Seguridad' };
        const dimLabels = { g:'General', p:'Particular', i:'Singular' };
        ['sus','sob','sol','seg'].forEach(n => ['g','p','i'].forEach(d => {
            matrixData[n][d].filter(x=>x.type==='destructive').forEach(x => {
                idx++;
                const el = document.getElementById(`eval-ind-${x.id}`);
                const val = el ? el.value.trim() : '(Sin completar)';
                indicatorsHtml += `<tr><td class="row-h">I.${idx}</td><td style="font-style:italic;color:#57534e;">${escHtml(x.text)}<br><span style="font-size:7.5pt;color:#a8a29e;">${nodeLabels[n]} ‚Äî ${dimLabels[d]}</span></td><td>${escHtml(val||'(Sin definir)')}</td></tr>`;
            });
        }));
        const gv = id => { const el = document.getElementById(id); return el ? (el.value.trim()||'(Sin completar)') : '(Sin completar)'; };
        const territory = document.getElementById('territory-input').value || '---';
        const autor = gv('him-autor'); const fecha = gv('him-fecha');

        openPrintWindow(`<div class="page">
            <div class="header">
                <h1>Informe de Evaluaci√≥n HiMupAC</h1>
                <p class="sub">Evaluaci√≥n del proceso de Historias Musicales para el Aprendizaje Colectivo</p>
                <p class="meta">Territorio: <strong>${escHtml(territory)}</strong> &nbsp;|&nbsp; Facilitador/a: <strong>${escHtml(autor)}</strong> &nbsp;|&nbsp; Fecha: <strong>${escHtml(fecha)}</strong></p>
                <p class="meta">P√°ez-Mora &amp; Cetina-Matallana (2025). <em>Global Health Promotion</em>. DOI: 10.1177/17579759251334393</p>
            </div>
            <div class="notice"><strong>Sobre la evaluaci√≥n:</strong> La evaluaci√≥n se adapta al contexto de cada territorio. Se mide el efecto de la estrategia sobre la percepci√≥n de cambio social. El alcance puede ser preventivo o de promoci√≥n de la salud, y las piezas pueden ser voz del colectivo en la lucha por justicia social.</div>
            ${indicatorsHtml ? `<div class="section-title">1. Indicadores por Proceso Cr√≠tico</div>
            <table><thead><tr><th>N¬∞</th><th>Proceso Cr√≠tico</th><th>Indicador de Seguimiento</th></tr></thead><tbody>${indicatorsHtml}</tbody></table>` : ''}
            <div class="section-title" style="margin-top:18px;">2. Percepci√≥n Comunitaria</div>
            <div class="content-box">${escHtml(gv('eval-percepcion'))}</div>
            <div class="section-title" style="margin-top:14px;">3. Cambio Social Percibido</div>
            <div class="content-box">${escHtml(gv('eval-cambio'))}</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px;" class="no-break">
                <div><div class="section-title">4. Indicadores Cuantitativos</div><div class="content-box">${escHtml(gv('eval-cuantitativo'))}</div></div>
                <div><div class="section-title">5. Evoluci√≥n de la Pieza</div><div class="content-box">${escHtml(gv('eval-evolucion'))}</div></div>
            </div>
            <div class="section-title" style="margin-top:14px;">6. Reflexi√≥n Cr√≠tica del Proceso</div>
            <div class="content-box amber">${escHtml(gv('eval-reflexion'))}</div>
            <div class="footer">Evaluaci√≥n HiMupAC &nbsp;|&nbsp; P√°ez-Mora &amp; Cetina-Matallana (2025) &nbsp;|&nbsp; Basado en Jaime Breilh, 2023 &nbsp;|&nbsp; Dise√±o: Carlos D. P√°ez-Mora, Areandina</div>
        </div>`);
    }


    function exportPraxis() {
        const territory = document.getElementById('territory-input').value || 'No definido';
        const gv = id => document.getElementById(id).value.trim() || '(Sin completar)';
        const rowData = [
            { nivel: 'GENERAL', desc: 'Nivel Estrat√©gico', color: '#78350f', bgColor: '#fff7ed',
              prev: gv('praxis-g-prev'), prom: gv('praxis-g-prom') },
            { nivel: 'PARTICULAR', desc: 'Nivel T√°ctico', color: '#0f766e', bgColor: '#f0fdfa',
              prev: gv('praxis-p-prev'), prom: gv('praxis-p-prom') },
            { nivel: 'SINGULAR', desc: 'Nivel Puntual', color: '#b45309', bgColor: '#fffbeb',
              prev: gv('praxis-i-prev'), prom: gv('praxis-i-prom') }
        ];

        const rows = rowData.map(r => `
            <div class="no-break" style="margin-bottom:20px;border:1px solid #e5e7eb;border-radius:6px;overflow:hidden;">
                <div style="background:${r.bgColor};border-bottom:2px solid ${r.color};padding:10px 14px;">
                    <strong style="color:${r.color};font-size:11pt;">${r.nivel}</strong>
                    <span style="color:#78716c;font-size:9pt;margin-left:8px;">${r.desc}</span>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;">
                    <div style="padding:14px;border-right:1px solid #f3f4f6;">
                        <div style="font-size:8.5pt;font-weight:bold;color:#991b1b;text-transform:uppercase;margin-bottom:8px;background:#fee2e2;padding:4px 8px;border-radius:3px;">üõ°Ô∏è Prevenci√≥n Cr√≠tica ‚Äî Transformaci√≥n Estructural</div>
                        <div style="font-size:10pt;white-space:pre-wrap;word-break:break-word;min-height:40px;">${escHtml(r.prev)}</div>
                    </div>
                    <div style="padding:14px;">
                        <div style="font-size:8.5pt;font-weight:bold;color:#166534;text-transform:uppercase;margin-bottom:8px;background:#dcfce7;padding:4px 8px;border-radius:3px;">üå± Promoci√≥n Emancipadora ‚Äî Potenciaci√≥n de la Vida</div>
                        <div style="font-size:10pt;white-space:pre-wrap;word-break:break-word;min-height:40px;">${escHtml(r.prom)}</div>
                    </div>
                </div>
            </div>`).join('');

        const html = `<div class="page">
            <div class="header">
                <h1>Plan de Acci√≥n Cr√≠tica</h1>
                <p class="sub">Matriz de Prevenci√≥n Cr√≠tica y Promoci√≥n Emancipadora de la Salud</p>
                <p class="meta">Territorio: <strong>${escHtml(territory)}</strong> &nbsp;|&nbsp; Herramienta de Epidemiolog√≠a Cr√≠tica &nbsp;|&nbsp; P√°ez-Mora &amp; Cetina-Matallana (2025)</p>
            </div>

            <div class="notice">
                <strong>Marco Conceptual:</strong> Esta matriz supera la prevenci√≥n biom√©dica individual para proponer
                <strong>Prevenci√≥n Cr√≠tica</strong> (transformaci√≥n de las condiciones estructurales que generan enfermedad)
                y <strong>Promoci√≥n Emancipadora</strong> (potenciaci√≥n de la vida y los modos de existencia saludables),
                articuladas en los tres niveles de determinaci√≥n social: General, Particular y Singular.
            </div>

            <div class="section-title" style="margin-top:20px;">Matriz de Acci√≥n por Nivel de Determinaci√≥n</div>
            <div style="margin-bottom:10px;display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:9pt;font-weight:bold;">
                <div style="background:#fee2e2;padding:6px 10px;border-radius:4px;color:#991b1b;text-align:center;">üõ°Ô∏è PREVENCI√ìN CR√çTICA: Acciones de transformaci√≥n estructural</div>
                <div style="background:#dcfce7;padding:6px 10px;border-radius:4px;color:#166534;text-align:center;">üå± PROMOCI√ìN EMANCIPADORA: Potenciaci√≥n de la vida</div>
            </div>
            ${rows}
            <div class="footer">Epidemiolog√≠a Cr√≠tica ‚Äî Plan de Acci√≥n Cr√≠tica &nbsp;|&nbsp; P√°ez-Mora &amp; Cetina-Matallana (2025) &nbsp;|&nbsp; Basado en Jaime Breilh</div>
        </div>`;
        openPrintWindow(html);
    }

    // --- HIMUPAC ---
    function exportHimupac() {
        const gv = id => document.getElementById(id).value.trim() || '(Sin completar)';
        const territory = document.getElementById('territory-input').value || '---';
        const autor = gv('him-autor');
        const fecha = gv('him-fecha');
        const nivel = gv('him-nivel');

        // Nudos cr√≠ticos seleccionados
        const selectedTexts = himupacSelection.map(id => {
            let text = '';
            ['sus','sob','sol','seg'].forEach(n => ['g','p','i'].forEach(d => {
                const found = matrixData[n][d].find(x => x.id === id);
                if (found) text = found.text;
            }));
            return text;
        }).filter(Boolean);

        const nudosHtml = selectedTexts.length
            ? selectedTexts.map(t => `<li style="margin-bottom:6px;font-size:10.5pt;">${escHtml(t)}</li>`).join('')
            : '<li style="color:#aaa;font-style:italic;">Sin procesos seleccionados.</li>';

        const html = `<div class="page">
            <div class="header">
                <h1>Propuesta HiMupAC</h1>
                <p class="sub">Historias Musicales para el Aprendizaje Colectivo</p>
                <p class="meta">
                    Facilitador/a: <strong>${escHtml(autor)}</strong> &nbsp;|&nbsp;
                    Fecha: <strong>${escHtml(fecha)}</strong> &nbsp;|&nbsp;
                    Territorio: <strong>${escHtml(territory)}</strong>
                </p>
                <p class="meta" style="margin-top:4px;">Propuesta metodol√≥gica basada en Educaci√≥n Popular, Interculturalidad y Determinaci√≥n Social &nbsp;|&nbsp; P√°ez-Mora &amp; Cetina-Matallana (2025)</p>
            </div>

            <div class="notice">
                <strong>¬øQu√© es HiMupAC?</strong> El m√©todo de Historias Musicales para el Aprendizaje Colectivo (HiMupAC)
                usa narrativas sonoras situadas territorialmente para detonar procesos de <em>sentipensar</em> comunitario.
                No impone saber t√©cnico: dialoga con saberes locales para transformar la comprensi√≥n
                de los determinantes sociales de la salud en acci√≥n colectiva.
            </div>

            <div class="section-title" style="margin-top:18px;">Paso 1 ‚Äî Diagn√≥stico: Nudos Cr√≠ticos Seleccionados</div>
            <div style="background:#fff1f2;border:1px solid #fca5a5;border-radius:4px;padding:12px 16px;margin-top:6px;">
                <p style="font-size:9pt;color:#991b1b;font-weight:bold;margin-bottom:8px;">
                    Procesos malsanos que la historia debe abordar y transformar:
                </p>
                <ul style="padding-left:20px;">${nudosHtml}</ul>
            </div>

            <div class="section-title" style="margin-top:18px;">Paso 2 ‚Äî Fundamentaci√≥n Intercultural</div>
            <p style="font-size:9pt;color:#57534e;margin-bottom:4px;">
                Reconocimiento del Otro. El m√©todo no impone saber t√©cnico, sino que dialoga con los saberes locales.
            </p>
            <div class="content-box amber">${escHtml(gv('him-fundamentos'))}</div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;" class="no-break">
                <div>
                    <div class="section-title">Paso 3a ‚Äî Perfil del Personaje</div>
                    <p style="font-size:9pt;color:#57534e;margin-bottom:4px;">El personaje debe generar identificaci√≥n inmediata ("Ese soy yo") para facilitar el <em>sentipensar</em>.</p>
                    <div class="content-box">${escHtml(gv('him-personaje-perfil'))}</div>
                </div>
                <div>
                    <div class="section-title">Paso 3b ‚Äî Vivencia del Problema</div>
                    <p style="font-size:9pt;color:#57534e;margin-bottom:4px;">¬øC√≥mo vive, siente y sufre este personaje el proceso malsano seleccionado?</p>
                    <div class="content-box">${escHtml(gv('him-personaje-vivencia'))}</div>
                </div>
            </div>

            <div class="no-break" style="margin-top:16px;">
                <div class="section-title">Paso 4 ‚Äî Estrategia Narrativa</div>
                <p style="font-size:9pt;color:#57534e;margin-bottom:4px;">
                    Nivel de transformaci√≥n articulada: <strong style="color:#b45309;">${escHtml(nivel)}</strong>
                </p>
                <p style="font-size:9pt;color:#57534e;margin-bottom:4px;">Trama y desenlace. ¬øA d√≥nde se quiere llegar? ¬øC√≥mo se organiza el personaje o la comunidad para transformar la realidad? (Evitar soluciones m√°gicas).</p>
                <div class="content-box">${escHtml(gv('him-trama'))}</div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;" class="no-break">
                <div>
                    <div class="section-title">Paso 5a ‚Äî Est√©tica Sonora y Ritmo</div>
                    <p style="font-size:9pt;color:#57534e;margin-bottom:4px;">¬øQu√© ritmo musical y sonidos ambientales son propios del territorio?</p>
                    <div class="content-box">${escHtml(gv('him-ritmo'))}</div>
                </div>
                <div>
                    <div class="section-title">Paso 5b ‚Äî Saberes Populares</div>
                    <p style="font-size:9pt;color:#57534e;margin-bottom:4px;">Dichos, mensajes o conocimiento popular adaptado culturalmente.</p>
                    <div class="content-box">${escHtml(gv('him-dichos'))}</div>
                </div>
            </div>

            <div class="no-break" style="margin-top:16px;">
                <div class="section-title">Paso 6 ‚Äî Puesta en Escena (Co-construcci√≥n)</div>
                <p style="font-size:9pt;color:#57534e;margin-bottom:4px;">Estrategia de uso. ¬øC√≥mo se socializar√° para detonar el aprendizaje colectivo? (Educaci√≥n Popular).</p>
                <div class="content-box amber">${escHtml(gv('him-puesta'))}</div>
            </div>

            <div class="footer">M√©todo HiMupAC ‚Äî Historias Musicales para el Aprendizaje Colectivo &nbsp;|&nbsp; P√°ez-Mora &amp; Cetina-Matallana (2025) &nbsp;|&nbsp; Basado en Epidemiolog√≠a Cr√≠tica de Jaime Breilh</div>
        </div>`;
        openPrintWindow(html);
    }

    // Helpers
    function escHtml(s) {
        return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function getRadarAsImage() {
        try {
            const cv = document.getElementById('radarChart');
            if (!cv) return null;
            return cv.toDataURL('image/png');
        } catch(e) { return null; }
    }

    // Construye el diagrama de subsunci√≥n como SVG puro para impresi√≥n perfecta
    function buildSubsumptionSVG() {
        const W = 280, H = 280, cx = 140, cy = 140;
        const rings = [
            { r: 130, label: 'G', stroke: '#d97706', fill: 'rgba(255,251,235,0.6)', dim: 'g', minR: 90, maxR: 125 },
            { r: 85,  label: 'P', stroke: '#0d9488', fill: 'rgba(240,253,250,0.6)', dim: 'p', minR: 50, maxR: 80 },
            { r: 40,  label: 'S', stroke: '#f59e0b', fill: 'rgba(255,255,255,0.9)', dim: 'i', minR: 8,  maxR: 35 }
        ];

        let svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">`;
        svgContent += `<defs><style>.sl{font-family:Georgia,serif;font-weight:bold;font-size:8px;fill:#78350f;}</style></defs>`;

        // Circles
        rings.forEach(ring => {
            svgContent += `<circle cx="${cx}" cy="${cy}" r="${ring.r}" fill="${ring.fill}" stroke="${ring.stroke}" stroke-width="1.5" stroke-dasharray="${ring.r < 50 ? 'none' : '4,3'}"/>`;
            svgContent += `<text x="${cx}" y="${cy - ring.r + 10}" text-anchor="middle" class="sl">${ring.label}</text>`;
        });

        // Dots
        let seed = 0;
        rings.forEach(ring => {
            ['sus','sob','sol','seg'].forEach(n => {
                matrixData[n][ring.dim].forEach(x => {
                    seed++;
                    const ang = seededPos(seed * 7, 0, Math.PI * 2);
                    const r = seededPos(seed * 13, ring.minR, ring.maxR);
                    const px = cx + Math.cos(ang) * r;
                    const py = cy + Math.sin(ang) * r;
                    const col = nodeColors[n];
                    if (x.type === 'destructive') {
                        svgContent += `<rect x="${px-4}" y="${py-4}" width="8" height="8" fill="${col}" stroke="white" stroke-width="1" rx="1"/>`;
                    } else {
                        svgContent += `<circle cx="${px}" cy="${py}" r="4" fill="${col}" stroke="white" stroke-width="1"/>`;
                    }
                });
            });
        });

        svgContent += `</svg>`;
        return svgContent;
    }

    // ============================================================
    // PERSISTENCIA con localStorage
    // ============================================================
    let saveTimer = null;
    function autoSave() {
        clearTimeout(saveTimer);
        saveTimer = setTimeout(() => {
            try {
                const state = {
                    matrixData,
                    himupacSelection,
                    territory: document.getElementById('territory-input').value,
                    praxis: {
                        'g-prev': document.getElementById('praxis-g-prev').value,
                        'g-prom': document.getElementById('praxis-g-prom').value,
                        'p-prev': document.getElementById('praxis-p-prev').value,
                        'p-prom': document.getElementById('praxis-p-prom').value,
                        'i-prev': document.getElementById('praxis-i-prev').value,
                        'i-prom': document.getElementById('praxis-i-prom').value,
                    },
                    him: {
                        autor: document.getElementById('him-autor').value,
                        fecha: document.getElementById('him-fecha').value,
                        fundamentos: document.getElementById('him-fundamentos').value,
                        perfil: document.getElementById('him-personaje-perfil').value,
                        vivencia: document.getElementById('him-personaje-vivencia').value,
                        nivel: document.getElementById('him-nivel').value,
                        trama: document.getElementById('him-trama').value,
                        ritmo: document.getElementById('him-ritmo').value,
                        dichos: document.getElementById('him-dichos').value,
                        puesta: document.getElementById('him-puesta').value,
                        pubcanales: document.getElementById('him-publicacion-canales') ? document.getElementById('him-publicacion-canales').value : '',
                        pubestrategia: document.getElementById('him-publicacion-estrategia') ? document.getElementById('him-publicacion-estrategia').value : '',
                    },
                    eval: {
                        percepcion: document.getElementById('eval-percepcion') ? document.getElementById('eval-percepcion').value : '',
                        cambio: document.getElementById('eval-cambio') ? document.getElementById('eval-cambio').value : '',
                        cuantitativo: document.getElementById('eval-cuantitativo') ? document.getElementById('eval-cuantitativo').value : '',
                        evolucion: document.getElementById('eval-evolucion') ? document.getElementById('eval-evolucion').value : '',
                        reflexion: document.getElementById('eval-reflexion') ? document.getElementById('eval-reflexion').value : '',
                    }
                };
                localStorage.setItem('epi-critica-state', JSON.stringify(state));
                const ind = document.getElementById('save-indicator');
                ind.classList.add('show');
                setTimeout(() => ind.classList.remove('show'), 1800);
            } catch (e) { console.warn('No se pudo guardar en localStorage', e); }
        }, 800);
    }

    function restoreState() {
        try {
            const raw = localStorage.getItem('epi-critica-state');
            if (!raw) return;
            const state = JSON.parse(raw);
            matrixData = state.matrixData || matrixData;
            himupacSelection = state.himupacSelection || [];
            if (state.territory) document.getElementById('territory-input').value = state.territory;
            // Restaurar paneles con procesos
            Object.keys(matrixData).forEach(n => {
                ['g', 'p', 'i'].forEach(d => {
                    const listEl = document.getElementById(`list-${n}-${d}`);
                    if (listEl) {
                        matrixData[n][d].forEach(item => renderProcessItem(listEl, item, n, d));
                    }
                });
            });
            // Praxis
            if (state.praxis) {
                Object.keys(state.praxis).forEach(k => {
                    const el = document.getElementById(`praxis-${k}`);
                    if (el) el.value = state.praxis[k];
                });
            }
            // HiMupAC
            if (state.him) {
                const map = {
                    autor: 'him-autor', fecha: 'him-fecha', fundamentos: 'him-fundamentos',
                    perfil: 'him-personaje-perfil', vivencia: 'him-personaje-vivencia',
                    nivel: 'him-nivel', trama: 'him-trama', ritmo: 'him-ritmo',
                    dichos: 'him-dichos', puesta: 'him-puesta',
                    pubcanales: 'him-publicacion-canales', pubestrategia: 'him-publicacion-estrategia'
                };
                Object.keys(map).forEach(k => {
                    const el = document.getElementById(map[k]);
                    if (el && state.him[k]) el.value = state.him[k];
                });
            }
            // Evaluaci√≥n
            if (state.eval) {
                const evalMap = {
                    percepcion: 'eval-percepcion', cambio: 'eval-cambio',
                    cuantitativo: 'eval-cuantitativo', evolucion: 'eval-evolucion', reflexion: 'eval-reflexion'
                };
                Object.keys(evalMap).forEach(k => {
                    const el = document.getElementById(evalMap[k]);
                    if (el && state.eval[k]) el.value = state.eval[k];
                });
            }
        } catch (e) { console.warn('No se pudo restaurar estado:', e); }
    }

    function clearAllData() {
        if (!confirm('¬øLimpiar toda la sesi√≥n guardada? Esta acci√≥n no se puede deshacer.')) return;
        localStorage.removeItem('epi-critica-state');
        matrixData = { sus: { g: [], p: [], i: [] }, sob: { g: [], p: [], i: [] }, sol: { g: [], p: [], i: [] }, seg: { g: [], p: [], i: [] } };
        himupacSelection = [];
        location.reload();
    }

    // ============================================================
    // INICIALIZACI√ìN
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
        buildMatrixPanels();   // FIX 1: construir DOM sin document.write
        restoreState();        // Persistencia
    });
    // ============================================================
    // DARK MODE
    // ============================================================
    function toggleDark() {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark');
        document.getElementById('dm-icon').textContent  = isDark ? '‚òÄÔ∏è' : 'üåô';
        document.getElementById('dm-label').textContent = isDark ? 'Claro' : 'Oscuro';
        try { localStorage.setItem('epi-dark', isDark ? '1' : '0'); } catch(e){}
    }
    // Apply saved dark preference on load
    (function(){
        try {
            const saved = localStorage.getItem('epi-dark');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (saved === '1' || (saved === null && prefersDark)) {
                document.documentElement.classList.add('dark');
                document.getElementById('dm-icon').textContent  = '‚òÄÔ∏è';
                document.getElementById('dm-label').textContent = 'Claro';
            }
        } catch(e){}
    })();

    </script>
</body>
</html>
